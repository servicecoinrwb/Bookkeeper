<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookkeeper Pro</title>
    <!-- Favicon to fix 404 error -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .table-scrollbar::-webkit-scrollbar {
            height: 8px;
        }
        .table-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #toast {
            transform: translateX(150%);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        /* For Searchable Dropdown */
        .searchable-dropdown {
            position: relative;
        }
        .dropdown-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            width: 100%;
            z-index: 10;
            max-height: 150px;
            overflow-y: auto;
        }
        .dropdown-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .dropdown-item:hover {
            background-color: #f3f4f6;
        }
        /* Auth UI */
        .hidden { display: none; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- App Container -->
    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">

            <!-- Header -->
            <header class="mb-8">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Bookkeeper Pro</h1>
                        <p class="text-gray-500 mt-1">Cloud-enabled Accounting Tool</p>
                    </div>
                    
                    <!-- Auth Section -->
                    <div class="flex items-center gap-3">
                        <!-- Loading Spinner for Auth -->
                        <div id="auth-loading" class="hidden">
                            <div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-6 w-6"></div>
                        </div>

                        <!-- Guest View -->
                        <button id="login-btn" class="hidden flex items-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors text-sm font-semibold">
                            <svg class="w-4 h-4" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                            Sign In with Google
                        </button>

                        <!-- Logged In View -->
                        <div id="user-info" class="hidden flex items-center gap-3 bg-white border border-gray-200 px-3 py-1.5 rounded-full shadow-sm">
                            <img id="user-avatar" src="" alt="User" class="w-6 h-6 rounded-full">
                            <span id="user-name" class="text-sm font-medium text-gray-700 truncate max-w-[150px]"></span>
                            <button id="logout-btn" class="text-xs text-red-600 hover:text-red-800 font-semibold ml-2">Sign Out</button>
                        </div>

                        <!-- External Links -->
                        <div class="hidden md:flex items-center gap-3 border-l pl-4 border-gray-300">
                            <!-- Service App Link -->
                            <a href="https://www.appsheet.com/start/90811d78-1165-4542-bbaa-af393ca455a5?platform=desktop#appName=SVC-QApp-721685306&vss=H4sIAAAAAAAAA52OvQ7CMBCD38VzniArYgAEC4iFdEibqxTRJlWTAlWUd-fCj1iB8Xz-bCdcLF33UTdnyFP6XBuaIZEUDvNAClJh4V0cfacgFHa6f4prXweFjFyJNxspQKbvUfl_q4A15KJtLY0lp1DMvxh-F4KF4kcW6Keo644eI9mfM2utb6ZA5sgTfqwOK7e8DdqZrTcc1-ouUL4DXt8N6VEBAAA=&view=Jobs" target="_blank" class="flex items-center gap-1 text-blue-600 hover:text-blue-800 text-xs font-bold bg-blue-50 px-2 py-1 rounded border border-blue-100 transition-colors">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                Service App
                            </a>
                            
                            <!-- Bank Link -->
                            <a href="https://www.communitychoicecu.com/" target="_blank" class="flex items-center gap-1 text-emerald-700 hover:text-emerald-900 text-xs font-bold bg-emerald-50 px-2 py-1 rounded border border-emerald-100 transition-colors">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>
                                Bank
                            </a>

                            <!-- Intuit Link -->
                            <a href="https://accounts.intuit.com/app/account-manager/overview" target="_blank" class="text-gray-500 hover:text-indigo-600 text-xs">Intuit</a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main>
                <!-- Status Bar for Cloud Sync -->
                <div id="cloud-status" class="hidden mb-4 bg-blue-50 text-blue-700 px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                    <svg class="animate-spin h-4 w-4 text-blue-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Syncing with cloud...
                </div>

                <!-- Step 1: File Upload -->
                <div id="upload-section" class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4">Step 1: Import Transactions</h2>
                    <p class="text-gray-600 mb-4">Upload a CSV file from your bank. Or, log in to load a previously saved session.</p>
                    <div class="flex items-center justify-center w-full">
                        <label for="csv-file" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h5l5 5v7a4 4 0 01-4 4H7z"></path></svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                                <p class="text-xs text-gray-500">CSV file (max 5MB)</p>
                            </div>
                            <input id="csv-file" type="file" class="hidden" accept=".csv" />
                        </label>
                    </div>
                    <div id="file-info" class="mt-4 text-sm text-gray-600"></div>
                </div>

                <!-- Step 2: Categorization & Export (hidden initially) -->
                <div id="data-section" class="hidden mt-8">
                    <!-- Dashboard -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
                        <div class="bg-green-50 border-l-4 border-green-500 text-green-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">TOTAL INCOME</div>
                            <div id="total-income" class="text-2xl font-bold">$0.00</div>
                        </div>
                        <div class="bg-red-50 border-l-4 border-red-500 text-red-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">BUSINESS EXPENSE</div>
                            <div id="total-expense" class="text-2xl font-bold">$0.00</div>
                        </div>
                        <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">NET PROFIT</div>
                            <div id="net-total" class="text-2xl font-bold">$0.00</div>
                        </div>
                         <div id="ar-card" class="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">A/R (OWED TO YOU) <span id="ar-past-due-warning" class="text-xs font-bold ml-2 hidden">(PAST DUE)</span></div>
                            <div id="total-ar" class="text-2xl font-bold">$0.00</div>
                        </div>
                        <div class="bg-orange-50 border-l-4 border-orange-500 text-orange-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">A/P (YOU OWE)</div>
                            <div id="total-ap" class="text-2xl font-bold">$0.00</div>
                        </div>
                        <div class="bg-purple-50 border-l-4 border-purple-500 text-purple-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">Revenue</div>
                            <div id="total-draws" class="text-2xl font-bold">$0.00</div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <div class="flex flex-col md:flex-row justify-between md:items-center mb-4">
                            <h2 class="text-xl font-semibold">Step 2: Process Transactions</h2>
                             <!-- Tab Navigation -->
                            <div class="mt-4 md:mt-0 border-b border-gray-200">
                                <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
                                    <button id="tab-transactions" class="border-indigo-500 text-indigo-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" aria-current="page">Transactions</button>
                                    <button id="tab-jobs" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Job Profitability</button>
                                    <button id="tab-ar" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">A/R (Invoices)</button>
                                    <button id="tab-ap" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">A/P (Bills)</button>
                                    <button id="tab-reports" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Reports</button>
                                    <button id="tab-taxes" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Taxes</button>
                                    <button id="tab-guide" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Bookkeeping Guide</button>
                                </nav>
                            </div>
                        </div>
                        
                         <!-- QuickBooks Account Inputs -->
                        <div id="quickbooks-inputs" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                            <div>
                                <label for="bank-account" class="block text-sm font-medium text-gray-700">QuickBooks Bank Account</label>
                                <input type="text" id="bank-account" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Checking">
                            </div>
                            <div>
                                <label for="default-expense-account" class="block text-sm font-medium text-gray-700">Default Expense Account</label>
                                <input type="text" id="default-expense-account" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Uncategorized Expense">
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div id="action-buttons-container" class="flex flex-wrap items-center gap-4 mb-4">
                            <button id="export-button" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Export to QuickBooks (.iif)</button>
                            <button id="add-category-button" class="bg-gray-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">Manage Categories</button>
                             <button id="rules-button" class="bg-purple-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">Categorization Rules</button>
                             <button id="save-session-button" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">Save Session</button>
                            <button id="clear-session-button" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">Clear Data</button>
                            <!-- Date Filters -->
                            <div id="date-filter-container" class="ml-auto flex gap-2">
                                <select id="year-filter" class="block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                                <select id="month-filter" class="block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                            </div>
                        </div>

                        <!-- Transactions View -->
                        <div id="view-transactions">
                            <div class="mb-4">
                               <button id="import-more-transactions-button" class="bg-indigo-100 text-indigo-800 px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-sm font-semibold">Import More Transactions</button>
                            </div>
                            <!-- Transaction Table -->
                            <div class="overflow-x-auto table-scrollbar">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rec</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job/Customer</th>
                                            <th scope="col" class="relative px-6 py-3">
                                                <span class="sr-only">Edit</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="transaction-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Job Profitability View -->
                        <div id="view-jobs" class="hidden">
                             <div class="overflow-x-auto table-scrollbar">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job/Customer</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Income</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expenses</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Profit</th>
                                        </tr>
                                    </thead>
                                    <tbody id="job-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Job rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Accounts Receivable View -->
                        <div id="view-ar" class="hidden">
                            <div class="flex flex-wrap items-center gap-4 mb-4">
                                <button id="add-invoice-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Add New Invoice</button>
                                <label for="invoice-csv-file" class="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg shadow-sm hover:bg-blue-200 cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Import Invoice CSV
                                </label>
                                <input type="file" id="invoice-csv-file" class="hidden" accept=".csv">
                                <!-- Search AR -->
                                <div class="relative ml-auto w-full md:w-64">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                    </div>
                                    <input type="text" id="ar-search" class="block w-full pl-10 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Search Customers...">
                                </div>
                            </div>
                            <div class="overflow-x-auto table-scrollbar">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Invoice #</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="ar-table" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Accounts Payable View -->
                        <div id="view-ap" class="hidden">
                            <div class="flex flex-wrap items-center gap-4 mb-4">
                                <button id="add-bill-button" class="bg-orange-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">Add New Bill</button>
                                <!-- Search AP -->
                                <div class="relative ml-auto w-full md:w-64">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                    </div>
                                    <input type="text" id="ap-search" class="block w-full pl-10 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Search Vendors...">
                                </div>
                            </div>
                            <div class="overflow-x-auto table-scrollbar">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bill #</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="ap-table" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Reports View -->
                        <div id="view-reports" class="hidden">
                             <div class="mb-4 border-b border-gray-200">
                                <nav class="-mb-px flex space-x-8" aria-label="Report Tabs">
                                    <button id="report-tab-pl" class="border-indigo-500 text-indigo-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Profit & Loss</button>
                                    <button id="report-tab-ar-aging" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">A/R Aging</button>
                                    <button id="report-tab-ap-aging" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">A/P Aging</button>
                                </nav>
                            </div>
                            <div id="report-pl-content" class="prose max-w-none prose-indigo"></div>
                            <div id="report-ar-aging-content" class="hidden prose max-w-none prose-indigo"></div>
                            <div id="report-ap-aging-content" class="hidden prose max-w-none prose-indigo"></div>
                        </div>

                         <!-- Taxes View -->
                        <div id="view-taxes" class="hidden">
                            <!-- Settings & Summary -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Tax Settings</h3>
                                    <div class="flex items-center justify-between">
                                        <label for="tax-rate-input" class="text-sm font-medium text-gray-700">Estimated Tax Rate (%)</label>
                                        <input type="number" id="tax-rate-input" value="30" class="w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm text-right" min="0" max="100">
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">Typical rate is 25-30% (Self-Employment + Income Tax).</p>
                                </div>
                                <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-lg">
                                    <h3 class="text-lg font-semibold text-indigo-900 mb-2">Current Liability</h3>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-indigo-700">Net Profit (Selected Year):</span>
                                        <span id="tax-net-profit" class="font-bold">$0.00</span>
                                    </div>
                                    <div class="flex justify-between text-lg font-bold border-t border-indigo-200 pt-2 mt-2">
                                        <span class="text-indigo-900">Est. Taxes Due:</span>
                                        <span id="tax-total-due" class="text-indigo-600">$0.00</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Quarterly Payments Table -->
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Quarterly Payment Estimates</h3>
                            <div id="tax-year-warning" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert">
                                <p>Please select a specific <strong>Year</strong> from the filters above to see accurate quarterly estimates.</p>
                            </div>
                            <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 sm:rounded-lg mb-6">
                                <table class="min-w-full divide-y divide-gray-300">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">Quarter</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Due Date</th>
                                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Period Covered</th>
                                            <th scope="col" class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Est. Payment</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200 bg-white">
                                        <tr>
                                            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">Q1</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">April 15</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">Jan 1 â€“ Mar 31</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-right font-medium" id="tax-q1">$0.00</td>
                                        </tr>
                                        <tr>
                                            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">Q2</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">June 15</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">Apr 1 â€“ May 31</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-right font-medium" id="tax-q2">$0.00</td>
                                        </tr>
                                        <tr>
                                            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">Q3</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">Sept 15</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">Jun 1 â€“ Aug 31</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-right font-medium" id="tax-q3">$0.00</td>
                                        </tr>
                                        <tr>
                                            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">Q4</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">Jan 15 (Next Year)</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">Sep 1 â€“ Dec 31</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-right font-medium" id="tax-q4">$0.00</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Tax Concepts Guide -->
                            <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                <h3 class="text-lg font-semibold text-gray-900 mb-3">Tax Concepts: Paying Yourself vs. Business Expenses</h3>
                                <div class="space-y-4 text-sm text-gray-600">
                                    <p>
                                        <strong>The "Profit" Bucket:</strong>
                                        The IRS taxes you on your business <em>Profit</em> (Total Income minus Business Expenses). This happens regardless of where the money sits (in your business account, personal account, or under your mattress).
                                    </p>
                                    <div class="bg-blue-50 p-3 rounded-md border-l-4 border-blue-400">
                                        <p class="font-medium text-blue-900">Scenario: "Writing a Check to Myself"</p>
                                        <p class="mt-1">
                                            When you transfer money from your business checking to your personal savings (or any personal account), this is called an <strong>Owner's Draw</strong>.
                                        </p>
                                        <ul class="list-disc list-inside mt-2 ml-2 space-y-1">
                                            <li>It is <strong>NOT</strong> a tax-deductible business expense.</li>
                                            <li>It does <strong>NOT</strong> lower your taxable profit.</li>
                                            <li>It is simply you taking your "paycheck" after taxes are calculated on the profit.</li>
                                        </ul>
                                    </div>
                                    <p>
                                        <strong>How to Pay Taxes:</strong>
                                        Since taxes aren't withheld from your Owner's Draw like a regular paycheck, you must make estimated quarterly payments to the IRS based on the schedule above.
                                    </p>
                                </div>
                            </div>
                        </div>


                        <!-- Bookkeeping Guide View -->
                        <div id="view-guide" class="hidden prose max-w-none prose-indigo">
                            <h3 class="text-xl font-semibold mb-4">HVAC Bookkeeping Guide</h3>
                            <div class="space-y-4" id="accordion-container">
                                <!-- Accordion items will be populated by JS -->
                            </div>
                        </div>

                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95">
            <div class="p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-2">Edit Transaction</h3>
                <p id="modal-description" class="text-sm text-gray-600 mb-4"></p>
                
                <form id="edit-form">
                    <input type="hidden" id="modal-transaction-id">
                    <div class="searchable-dropdown">
                        <label for="modal-category" class="block text-sm font-medium text-gray-700">Category</label>
                        <input type="text" id="modal-category-search" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" autocomplete="off">
                        <div id="modal-category-dropdown" class="dropdown-menu hidden"></div>
                        <input type="hidden" id="modal-category">
                    </div>
                    <div class="mt-4">
                        <label for="modal-job" class="block text-sm font-medium text-gray-700">Job/Customer Name</label>
                        <input type="text" id="modal-job" list="job-list" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-gray-300 rounded-md" placeholder="e.g., Smith Residence Install">
                        <datalist id="job-list"></datalist>
                    </div>
                    <div class="mt-4">
                        <label for="modal-notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="modal-notes" rows="3" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-gray-300 rounded-md"></textarea>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="save-button" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">Save</button>
                <button id="cancel-button" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Manage Categories Modal -->
    <div id="category-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg m-4 transform scale-95">
             <div class="p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Manage Categories</h3>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="new-category-name" placeholder="New category name" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <button id="add-new-category-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Add</button>
                </div>
                <div id="category-list" class="max-h-60 overflow-y-auto pr-2">
                    <!-- Category list will be populated here -->
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="close-category-modal" type="button" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm">Done</button>
            </div>
        </div>
    </div>
    
    <!-- Categorization Rules Modal -->
    <div id="rules-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 transform scale-95">
             <div class="p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Categorization Rules</h3>
                <p class="text-sm text-gray-500 mb-4">Create rules to automatically categorize transactions on import.</p>
                <div class="grid grid-cols-3 gap-4 mb-4 items-end p-4 bg-gray-50 rounded-lg border">
                    <div>
                         <label for="rule-keyword" class="block text-sm font-medium text-gray-700">If description contains:</label>
                        <input type="text" id="rule-keyword" placeholder="e.g., Speedway" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="rule-category" class="block text-sm font-medium text-gray-700">Set category to:</label>
                        <select id="rule-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                    </div>
                    <button id="add-rule-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 h-fit">Add Rule</button>
                </div>
                <div id="rules-list" class="max-h-60 overflow-y-auto pr-2">
                    <!-- Rules list will be populated here -->
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="close-rules-modal" type="button" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm">Done</button>
            </div>
        </div>
    </div>


    <!-- A/P and A/R Modal -->
    <div id="ap-ar-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95">
            <div class="p-6">
                <h3 id="ap-ar-modal-title" class="text-lg font-medium leading-6 text-gray-900 mb-4">Add New Bill</h3>
                <form id="ap-ar-form">
                    <input type="hidden" id="ap-ar-id">
                    <input type="hidden" id="ap-ar-type">
                    <div>
                        <label id="ap-ar-party-label" for="ap-ar-party" class="block text-sm font-medium text-gray-700">Vendor</label>
                        <input type="text" id="ap-ar-party" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div class="mt-4">
                        <label for="ap-ar-number" class="block text-sm font-medium text-gray-700">Bill/Invoice #</label>
                        <input type="text" id="ap-ar-number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div>
                            <label for="ap-ar-date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="ap-ar-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="ap-ar-amount" class="block text-sm font-medium text-gray-700">Amount</label>
                            <input type="number" id="ap-ar-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" step="0.01">
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="ap-ar-save-button" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">Save</button>
                <button id="ap-ar-cancel-button" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>


    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95">
            <div class="p-6">
                <div class="flex items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="confirm-modal-title">Clear Session Data</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500" id="confirm-modal-body">Are you sure you want to clear all saved transaction data? This action cannot be undone.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="confirm-delete-button" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">Delete</button>
                <button id="cancel-delete-button" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Batch Update Modal -->
    <div id="batch-update-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95">
            <div class="p-6">
                 <div class="mt-3 text-center sm:mt-0 sm:text-left">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Apply to Similar Transactions?</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500" id="batch-update-body">We found X other transactions with a similar description. Would you like to change their category as well?</p>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="batch-update-confirm-button" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">Yes, Apply to All</button>
                <button id="batch-update-cancel-button" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">No, Just This One</button>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md transition-transform duration-300">
        Session Saved!
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBwuxBEU2Yt-QGtCbnyOYf7sEfqjTG0agc",
          authDomain: "bookkeeper-478720.firebaseapp.com",
          projectId: "bookkeeper-478720",
          storageBucket: "bookkeeper-478720.firebasestorage.app",
          messagingSenderId: "46086691914",
          appId: "1:46086691914:web:f6e33d544943dd24ab9ab3",
          measurementId: "G-4WCP4Q5ZBZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        // --- STATE MANAGEMENT ---
        let allData = []; 
        let categories = [
            'Uncategorized', 'Income', 'Office Supplies', 'Rent', 
            'Utilities', 'Travel', 'Meals', 'Software', 'Marketing',
            'Parts & Materials', 'Inventory Purchase', 'Owner\'s Draw'
        ];
        let categorizationRules = [];
        // New Search Terms
        let arSearchTerm = '';
        let apSearchTerm = '';

        // --- DOM ELEMENTS ---
        // Auth Elements
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const authLoading = document.getElementById('auth-loading');
        const cloudStatus = document.getElementById('cloud-status');

        const csvFileInput = document.getElementById('csv-file');
        const invoiceCsvFileInput = document.getElementById('invoice-csv-file');
        const fileInfo = document.getElementById('file-info');
        const uploadSection = document.getElementById('upload-section');
        const dataSection = document.getElementById('data-section');
        const transactionTableBody = document.getElementById('transaction-table');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const netTotalEl = document.getElementById('net-total');
        const totalAREl = document.getElementById('total-ar');
        const totalAPEl = document.getElementById('total-ap');
        const totalUnreconciledEl = document.getElementById('total-unreconciled');
        const totalDrawsEl = document.getElementById('total-draws');
        const arCard = document.getElementById('ar-card');
        const arPastDueWarning = document.getElementById('ar-past-due-warning');
        const importMoreTransactionsButton = document.getElementById('import-more-transactions-button');

        const exportButton = document.getElementById('export-button');
        const saveSessionButton = document.getElementById('save-session-button');
        const clearSessionButton = document.getElementById('clear-session-button');

        // Tab elements
        const tabs = {
            transactions: document.getElementById('tab-transactions'),
            jobs: document.getElementById('tab-jobs'),
            ar: document.getElementById('tab-ar'),
            ap: document.getElementById('tab-ap'),
            reports: document.getElementById('tab-reports'),
            taxes: document.getElementById('tab-taxes'),
            guide: document.getElementById('tab-guide'),
        };
        const views = {
            transactions: document.getElementById('view-transactions'),
            jobs: document.getElementById('view-jobs'),
            ar: document.getElementById('view-ar'),
            ap: document.getElementById('view-ap'),
            reports: document.getElementById('view-reports'),
            taxes: document.getElementById('view-taxes'),
            guide: document.getElementById('view-guide'),
        };

        const jobTableBody = document.getElementById('job-table');
        const arTableBody = document.getElementById('ar-table');
        const apTableBody = document.getElementById('ap-table');
        const quickbooksInputs = document.getElementById('quickbooks-inputs');
        const actionButtonsContainer = document.getElementById('action-buttons-container');
        
        // Report Elements
        const reportTabPl = document.getElementById('report-tab-pl');
        const reportTabArAging = document.getElementById('report-tab-ar-aging');
        const reportTabApAging = document.getElementById('report-tab-ap-aging');
        const reportPlContent = document.getElementById('report-pl-content');
        const reportArAgingContent = document.getElementById('report-ar-aging-content');
        const reportApAgingContent = document.getElementById('report-ap-aging-content');

        // Tax Elements
        const taxRateInput = document.getElementById('tax-rate-input');
        const taxNetProfitEl = document.getElementById('tax-net-profit');
        const taxTotalDueEl = document.getElementById('tax-total-due');
        const taxQ1El = document.getElementById('tax-q1');
        const taxQ2El = document.getElementById('tax-q2');
        const taxQ3El = document.getElementById('tax-q3');
        const taxQ4El = document.getElementById('tax-q4');
        const taxYearWarning = document.getElementById('tax-year-warning');

        // Modal elements
        const editModal = document.getElementById('edit-modal');
        const modalDescription = document.getElementById('modal-description');
        const modalTransactionId = document.getElementById('modal-transaction-id');
        const modalCategory = document.getElementById('modal-category');
        const modalCategorySearch = document.getElementById('modal-category-search');
        const modalCategoryDropdown = document.getElementById('modal-category-dropdown');
        const modalJob = document.getElementById('modal-job');
        const modalNotes = document.getElementById('modal-notes');
        const saveButton = document.getElementById('save-button');
        const cancelButton = document.getElementById('cancel-button');

        // Category Modal elements
        const categoryModal = document.getElementById('category-modal');
        const addCategoryButton = document.getElementById('add-category-button');
        const closeCategoryModalButton = document.getElementById('close-category-modal');
        const addNewCategoryBtn = document.getElementById('add-new-category-btn');
        const newCategoryNameInput = document.getElementById('new-category-name');
        const categoryListContainer = document.getElementById('category-list');
        
        // Rules Modal elements
        const rulesModal = document.getElementById('rules-modal');
        const rulesButton = document.getElementById('rules-button');
        const closeRulesModalButton = document.getElementById('close-rules-modal');
        const addRuleBtn = document.getElementById('add-rule-btn');
        const ruleKeywordInput = document.getElementById('rule-keyword');
        const ruleCategorySelect = document.getElementById('rule-category');
        const rulesListContainer = document.getElementById('rules-list');

        // AP/AR Modal Elements
        const apArModal = document.getElementById('ap-ar-modal');
        const apArModalTitle = document.getElementById('ap-ar-modal-title');
        const apArForm = document.getElementById('ap-ar-form');
        const apArId = document.getElementById('ap-ar-id');
        const apArType = document.getElementById('ap-ar-type');
        const apArPartyLabel = document.getElementById('ap-ar-party-label');
        const apArParty = document.getElementById('ap-ar-party');
        const apArNumber = document.getElementById('ap-ar-number');
        const apArDate = document.getElementById('ap-ar-date');
        const apArAmount = document.getElementById('ap-ar-amount');
        const apArSaveButton = document.getElementById('ap-ar-save-button');
        const apArCancelButton = document.getElementById('ap-ar-cancel-button');
        const addInvoiceButton = document.getElementById('add-invoice-button');
        const addBillButton = document.getElementById('add-bill-button');
        // New Search Inputs
        const arSearchInput = document.getElementById('ar-search');
        const apSearchInput = document.getElementById('ap-search');
        
        // Batch Update Modal
        const batchUpdateModal = document.getElementById('batch-update-modal');
        const batchUpdateBody = document.getElementById('batch-update-body');
        const batchUpdateConfirmButton = document.getElementById('batch-update-confirm-button');
        const batchUpdateCancelButton = document.getElementById('batch-update-cancel-button');

        const bankAccountInput = document.getElementById('bank-account');
        const defaultExpenseAccountInput = document.getElementById('default-expense-account');
        const yearFilter = document.getElementById('year-filter');
        const monthFilter = document.getElementById('month-filter');
        const dateFilterContainer = document.getElementById('date-filter-container');

        // Confirmation Modal elements
        const confirmModal = document.getElementById('confirm-modal');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');

        // --- AUTH FUNCTIONS ---
        const handleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login Failed:", error);
                showToast("Login failed", true);
            }
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
                allData = [];
                currentUser = null;
                dataSection.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                if(dateFilterContainer) dateFilterContainer.classList.add('hidden');
                showToast("Signed out");
            } catch (error) {
                console.error("Logout Failed:", error);
            }
        };

        onAuthStateChanged(auth, async (user) => {
            authLoading.classList.remove('hidden');
            loginBtn.classList.add('hidden');
            userInfo.classList.add('hidden');

            if (user) {
                currentUser = user;
                userInfo.classList.remove('hidden');
                userAvatar.src = user.photoURL || 'https://via.placeholder.com/150';
                userName.textContent = user.displayName || user.email;
                loginBtn.classList.add('hidden');
                await loadSession(); // Load from Cloud
            } else {
                currentUser = null;
                loginBtn.classList.remove('hidden');
                await loadSession(); // Load from LocalStorage
            }
            authLoading.classList.add('hidden');
        });


        // --- FUNCTIONS ---
        const parseDate = (dateString) => {
            if (!dateString) return null;
            const parts = dateString.match(/(\d+)/g);
            let date;
            if (parts && parts.length === 3) {
                const [month, day, year] = parts.map(p => parseInt(p, 10));
                if (month > 0 && month <= 12 && day > 0 && day <= 31) {
                    const fullYear = year < 100 ? 2000 + year : year;
                    date = new Date(fullYear, month - 1, day);
                }
            }
            if (!date || isNaN(date.getTime())) {
                date = new Date(dateString);
            }
            return !isNaN(date.getTime()) ? date : null;
        };

        const showToast = (message, isError = false) => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.toggle('bg-red-500', isError);
            toast.classList.toggle('bg-green-500', !isError);
            toast.style.transform = 'translateX(0)';
            setTimeout(() => {
                toast.style.transform = 'translateX(150%)';
            }, 3000);
        };

        const saveSession = async () => {
            if (currentUser) {
                // Save to Firestore
                try {
                    cloudStatus.classList.remove('hidden');
                    const userDocRef = doc(db, 'users', currentUser.uid);
                    // Storing data as a single JSON blob for simplicity in this architecture
                    // In a larger app, we would use subcollections.
                    await setDoc(userDocRef, {
                        data: JSON.stringify(allData),
                        categories: JSON.stringify(categories),
                        rules: JSON.stringify(categorizationRules),
                        lastUpdated: new Date()
                    });
                    cloudStatus.classList.add('hidden');
                    console.log("Session saved to Cloud.");
                } catch (e) {
                    cloudStatus.classList.add('hidden');
                    console.error("Error saving to cloud:", e);
                    showToast("Error saving to Cloud.", true);
                    return;
                }
            } else {
                // Save to LocalStorage
                try {
                    localStorage.setItem('bookkeeperSession', JSON.stringify(allData));
                    localStorage.setItem('bookkeeperCategories', JSON.stringify(categories));
                    localStorage.setItem('bookkeeperRules', JSON.stringify(categorizationRules));
                    console.log("Session saved locally.");
                } catch (e) {
                    console.error("Error saving session:", e);
                    showToast("Error saving session. Data might be too large.", true);
                    return;
                }
            }
        };

        const loadSession = async () => {
            if (currentUser) {
                // Load from Firestore
                try {
                    const userDocRef = doc(db, 'users', currentUser.uid);
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.data) allData = JSON.parse(data.data);
                        if (data.categories) categories = JSON.parse(data.categories);
                        if (data.rules) categorizationRules = JSON.parse(data.rules);
                    }
                } catch (e) {
                    console.error("Error loading from cloud:", e);
                    showToast("Error loading from cloud.", true);
                }
            } else {
                // Load from LocalStorage
                const savedSession = localStorage.getItem('bookkeeperSession');
                const savedCategories = localStorage.getItem('bookkeeperCategories');
                const savedRules = localStorage.getItem('bookkeeperRules');
                
                if (savedSession) {
                    try {
                          allData = JSON.parse(savedSession);
                    } catch(e) { console.error(e); }
                }
                if (savedCategories) categories = JSON.parse(savedCategories);
                if (savedRules) categorizationRules = JSON.parse(savedRules);
            }

            // Initialize UI after data load
            if (allData.length > 0) {
                populateDateFilters();
                renderAllData();
                uploadSection.classList.add('hidden');
                dataSection.classList.remove('hidden');
                if(dateFilterContainer) dateFilterContainer.classList.remove('hidden');
            } else {
                uploadSection.classList.remove('hidden');
                dataSection.classList.add('hidden');
            }
            
            // Re-init dropdowns
            populateCategoryDropdowns();
            populateCategoryManagementList();
            populateRulesList();
        };


        const formatCurrency = (amount) => {
            const value = parseFloat(amount);
            if (isNaN(value)) return '$0.00';
            return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        };
        
        const populateCategoryDropdowns = () => {
            if(!ruleCategorySelect) return;
            const optionsHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            ruleCategorySelect.innerHTML = optionsHTML;
            // Searchable dropdown is populated dynamically on input
        };

        const populateCategoryManagementList = () => {
             categoryListContainer.innerHTML = '';
             categories.forEach(cat => {
                 const isProtected = ['Uncategorized'].includes(cat);
                 const item = document.createElement('div');
                 item.className = 'flex justify-between items-center p-2 rounded-md hover:bg-gray-100';
                 item.innerHTML = `
                    <span>${cat}</span>
                    ${isProtected ? '' : `<button data-category="${cat}" class="delete-category-btn text-red-500 hover:text-red-700 text-sm font-semibold">Remove</button>`}
                 `;
                 categoryListContainer.appendChild(item);
             });
        };

        const populateRulesList = () => {
            rulesListContainer.innerHTML = '';
            categorizationRules.forEach((rule, index) => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 rounded-md hover:bg-gray-100';
                item.innerHTML = `
                    <span>If description contains "<strong>${rule.keyword}</strong>", set category to <strong>${rule.category}</strong>.</span>
                    <button data-index="${index}" class="delete-rule-btn text-red-500 hover:text-red-700 text-sm font-semibold">Remove</button>
                `;
                rulesListContainer.appendChild(item);
            });
        }

        const addCategory = (name) => {
            const newCat = name.trim();
            if(newCat && !categories.includes(newCat)){
                categories.push(newCat);
                categories.sort();
                saveSession();
                populateCategoryManagementList();
                populateCategoryDropdowns();
            }
            newCategoryNameInput.value = '';
        };

        const removeCategory = (name) => {
            if(name === 'Uncategorized') return;
            
            categories = categories.filter(c => c !== name);
            allData.forEach(tx => {
                if(tx.category === name) {
                    tx.category = 'Uncategorized';
                }
            });
            
            saveSession();
            populateCategoryManagementList();
            populateCategoryDropdowns();
            renderAllData();
        };

        const addRule = () => {
            const keyword = ruleKeywordInput.value.trim();
            const category = ruleCategorySelect.value;
            if(keyword && category) {
                categorizationRules.push({ keyword, category });
                saveSession();
                populateRulesList();
                ruleKeywordInput.value = '';
            }
        };

        const removeRule = (index) => {
            categorizationRules.splice(index, 1);
            saveSession();
            populateRulesList();
        };

        // --- REPLACED RENDER FUNCTION FOR DYNAMIC DASHBOARD ---
        const renderAllData = () => {
            const selectedYear = yearFilter.value;
            const selectedMonth = monthFilter.value;

            // 1. Filter EVERYTHING by Date first
            let filteredData = allData.filter(item => {
                if(!item.date) return false;
                const itemDate = new Date(item.date);
                if(isNaN(itemDate.getTime())) return false;

                const yearMatch = selectedYear === 'all' || !selectedYear || itemDate.getFullYear().toString() === selectedYear;
                const monthMatch = selectedMonth === 'all' || !selectedMonth || (itemDate.getMonth() + 1).toString() === selectedMonth;
                return yearMatch && monthMatch;
            });
            
            // 2. Separate Transactions
            const transactions = filteredData.filter(d => d.type === 'transaction');
            
            // 3. Filter AR by search term
            const arItems = filteredData.filter(d => {
                if (d.type !== 'ar') return false;
                if (!arSearchTerm) return true;
                return d.party.toLowerCase().includes(arSearchTerm.toLowerCase()) || 
                       d.number.toLowerCase().includes(arSearchTerm.toLowerCase());
            });

            // 4. Filter AP by search term
            const apItems = filteredData.filter(d => {
                if (d.type !== 'ap') return false;
                if (!apSearchTerm) return true;
                return d.party.toLowerCase().includes(apSearchTerm.toLowerCase()) || 
                       d.number.toLowerCase().includes(apSearchTerm.toLowerCase());
            });

            renderTransactions(transactions);
            
            // Calculate Dashboard based on FILTERED items
            updateDashboard(transactions, arItems, apItems); 

            renderJobProfitability(transactions);
            renderAR(arItems);
            renderAP(apItems);
            renderReports(transactions, arItems, apItems);
            renderTaxView(transactions);
        };

        const renderTransactions = (data) => {
            transactionTableBody.innerHTML = '';
            if (data.length === 0) {
                 transactionTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">No transactions for the selected period.</td></tr>`;
                 return;
            }
            
            data.forEach(tx => {
                const row = document.createElement('tr');
                const amountClass = tx.amount >= 0 ? 'text-green-600' : 'text-red-600';
                const categoryClass = tx.category === 'Uncategorized' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800';
                row.innerHTML = `
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" data-id="${tx.id}" class="reconcile-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" ${tx.reconciled ? 'checked' : ''}>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(tx.date).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 max-w-xs truncate" title="${tx.description}">${tx.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${amountClass}">${formatCurrency(tx.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${categoryClass}">${tx.category}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.job || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${tx.id}" class="edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                    </td>
                `;
                transactionTableBody.appendChild(row);
            });
        };

        const updateDashboard = (transactions, arItems, apItems) => {
            const income = transactions.filter(tx => tx.amount >= 0).reduce((sum, tx) => sum + tx.amount, 0);
            
            // FIXED: Exclude "Owner's Draw" from Business Expenses
            const expense = transactions.filter(tx => tx.amount < 0 && tx.category !== "Owner's Draw").reduce((sum, tx) => sum + tx.amount, 0);
            
            // FIXED: Calculate Owner's Draw Separately
            const draws = transactions.filter(tx => tx.amount < 0 && tx.category === "Owner's Draw").reduce((sum, tx) => sum + tx.amount, 0);

            const net = income + expense; // Expense is negative

            const totalAR = arItems.filter(i => i.status === 'unpaid').reduce((sum, i) => sum + i.amount, 0);
            const totalAP = apItems.filter(i => i.status === 'unpaid').reduce((sum, i) => sum + i.amount, 0);
            const unreconciledCount = transactions.filter(tx => !tx.reconciled).length;

            const sixtyDaysAgo = new Date();
            sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);
            // Check visible/filtered items for past due status
            const hasPastDue = arItems.some(item => item.status === 'unpaid' && new Date(item.date) < sixtyDaysAgo);

            totalIncomeEl.textContent = formatCurrency(income);
            totalExpenseEl.textContent = formatCurrency(Math.abs(expense));
            netTotalEl.textContent = formatCurrency(net);
            
            // New Stats
            totalDrawsEl.textContent = formatCurrency(Math.abs(draws));

            totalAREl.textContent = formatCurrency(totalAR);
            totalAPEl.textContent = formatCurrency(totalAP);
            totalUnreconciledEl.textContent = unreconciledCount;

            netTotalEl.parentElement.classList.toggle('bg-red-50', net < 0);
            netTotalEl.parentElement.classList.toggle('border-red-500', net < 0);
            netTotalEl.parentElement.classList.toggle('text-red-800', net < 0);
            netTotalEl.parentElement.classList.toggle('bg-green-50', net >= 0);
            netTotalEl.parentElement.classList.toggle('border-green-500', net >= 0);
            netTotalEl.parentElement.classList.toggle('text-green-800', net >= 0);

            if (hasPastDue) {
                arCard.classList.remove('bg-yellow-50', 'border-yellow-500', 'text-yellow-800');
                arCard.classList.add('bg-red-100', 'border-red-500', 'text-red-900');
                arPastDueWarning.classList.remove('hidden');
            } else {
                arCard.classList.add('bg-yellow-50', 'border-yellow-500', 'text-yellow-800');
                arCard.classList.remove('bg-red-100', 'border-red-500', 'text-red-900');
                arPastDueWarning.classList.add('hidden');
            }
        };

        const handleFileSelect = (file) => {
            if (!file) return;
            
            fileInfo.textContent = `File: ${file.name}`;
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    let newCategoriesFound = false;
                    const existingTxKeys = new Set(allData.filter(d => d.type === 'transaction').map(tx => `${tx.date}-${tx.description}-${tx.amount}`));

                    const importedTransactions = results.data.map((row, index) => {
                         let dateKey = Object.keys(row).find(k => k.toLowerCase().includes('date'));
                        let descriptionKey = Object.keys(row).find(k => k.toLowerCase().includes('description') || k.toLowerCase().includes('memo'));
                        let classificationKey = Object.keys(row).find(k => k.toLowerCase() === 'classification');
                        
                        let debitKey = Object.keys(row).find(k => k.toLowerCase() === 'debit');
                        let creditKey = Object.keys(row).find(k => k.toLowerCase() === 'credit');
                        let amountKey = Object.keys(row).find(k => k.toLowerCase().includes('amount'));

                        if (!dateKey || !descriptionKey) return null;
                        
                        let amount = 0;
                        if (debitKey || creditKey) {
                            const debitValue = row[debitKey] || "0";
                            const creditValue = row[creditKey] || "0";
                            const debit = parseFloat(debitValue.replace(/[^0-9.-]+/g, ""));
                            const credit = parseFloat(creditValue.replace(/[^0-9.-]+/g, ""));
                            
                            if (!isNaN(debit) && debit !== 0) amount = -debit;
                            else if (!isNaN(credit) && credit !== 0) amount = credit;
                        } else if (amountKey) {
                            const rawAmount = row[amountKey] || "0";
                            amount = parseFloat(rawAmount.replace(/[^0-9.-]+/g, ""));
                        } else {
                            return null;
                        }
                        
                        const parsedDate = parseDate(row[dateKey]);
                        if(!parsedDate) return null;
                        const date = parsedDate.toISOString().split('T')[0];
                        const description = row[descriptionKey] || 'No Description';
                        const key = `${date}-${description}-${amount}`;
                        if(existingTxKeys.has(key)) return null;

                        let category = (classificationKey && row[classificationKey] && row[classificationKey].trim()) || 'Uncategorized';
                        
                        // Apply rules
                        for (const rule of categorizationRules) {
                            if (description.toLowerCase().includes(rule.keyword.toLowerCase())) {
                                category = rule.category;
                                break;
                            }
                        }

                        if (category && !categories.includes(category)) {
                            categories.push(category);
                            newCategoriesFound = true;
                        }

                        return {
                            id: `tx-${Date.now()}-${index}`,
                            type: 'transaction',
                            date: date,
                            description: description,
                            amount: isNaN(amount) ? 0 : amount,
                            category: category,
                            notes: '',
                            job: '',
                            status: 'cleared', 
                            reconciled: false,
                        };
                    }).filter(Boolean); 

                    allData.push(...importedTransactions);
                    showToast(`${importedTransactions.length} new transactions added.`);
                    
                    if (newCategoriesFound) {
                        categories.sort();
                        populateCategoryDropdowns();
                        populateCategoryManagementList();
                    }

                    populateDateFilters();
                    renderAllData();
                    saveSession();
                    
                    uploadSection.classList.add('hidden');
                    dataSection.classList.remove('hidden');
                    if(dateFilterContainer) dateFilterContainer.classList.remove('hidden');
                },
                error: (error) => {
                    console.error('CSV Parsing Error:', error);
                    fileInfo.textContent = 'Error parsing CSV file. Check console for details.';
                }
            });
        };
        
        const handleInvoiceFileSelect = (file) => {
             if (!file) return;
            
            showToast(`Importing ${file.name}...`);
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    const importedInvoices = results.data.map((row, index) => {
                        const amountString = row['Grand Total'] || '$0.00';
                        const amount = parseFloat(amountString.replace(/[^0-9.-]+/g, ""));
                        const transDateStr = row['TransDate'];
                        if(!transDateStr) return null;
                        
                        const parsedDate = parseDate(transDateStr);
                        if(!parsedDate) return null;

                        return {
                            id: `ar-${Date.now()}-${index}`,
                            type: 'ar',
                            party: row['Customer'] || 'N/A',
                            number: row['INVNum'] || 'N/A',
                            date: parsedDate.toISOString().split('T')[0],
                            amount: isNaN(amount) ? 0 : amount,
                            status: (row['Invoice Status'] || '').toLowerCase() === 'paid' ? 'paid' : 'unpaid'
                        };
                    }).filter(Boolean);

                    // Prevent duplicates by checking invoice number
                    const existingInvoiceNumbers = new Set(allData.filter(d => d.type === 'ar').map(d => d.number));
                    const newInvoices = importedInvoices.filter(inv => inv.number && !existingInvoiceNumbers.has(inv.number));

                    allData.push(...newInvoices);
                    
                    populateDateFilters();
                    renderAllData();
                    saveSession();
                    showToast(`${newInvoices.length} new invoices imported.`);
                },
                error: (error) => {
                    console.error('Invoice CSV Parsing Error:', error);
                    showToast('Error parsing invoice file.', true);
                }
            });
        }

        const openEditModal = (transactionId) => {
            const tx = allData.find(t => t.id === transactionId);
            if (!tx) return;
            
            modalTransactionId.value = tx.id;
            modalDescription.textContent = tx.description;
            modalJob.value = tx.job;
            modalNotes.value = tx.notes;
            
            updateJobDatalist();
            
            modalCategory.value = tx.category;
            modalCategorySearch.value = tx.category;
            
            editModal.classList.remove('hidden');
            setTimeout(() => editModal.querySelector('.modal-content').classList.replace('scale-95', 'scale-100'), 10);
        };
        
        const closeEditModal = () => {
            editModal.querySelector('.modal-content').classList.replace('scale-100', 'scale-95');
            setTimeout(() => editModal.classList.add('hidden'), 300);
        };

        const saveTransaction = () => {
            const transactionId = modalTransactionId.value;
            const tx = allData.find(t => t.id === transactionId);
            const oldCategory = tx.category;
            const newCategory = modalCategory.value;

            if (tx) {
                tx.category = newCategory;
                tx.job = modalJob.value.trim();
                tx.notes = modalNotes.value;
            }
            
            closeEditModal();

            if (oldCategory !== newCategory) {
                const similarUncategorized = allData.filter(t => 
                    t.type === 'transaction' && 
                    t.id !== tx.id && 
                    t.description.toLowerCase().includes(tx.description.split(' ')[0].toLowerCase())
                );
                
                if (similarUncategorized.length > 0) {
                    batchUpdateBody.textContent = `We found ${similarUncategorized.length} other transactions with a similar description ("${tx.description.split(' ')[0]}..."). Would you like to change their category to "${newCategory}" as well?`;
                    
                    const confirmHandler = () => {
                        similarUncategorized.forEach(t => t.category = newCategory);
                        closeBatchUpdateModal();
                        renderAllData();
                        saveSession();
                    };

                    const cancelHandler = () => {
                        closeBatchUpdateModal();
                        renderAllData();
                        saveSession();
                    }
                    
                    batchUpdateConfirmButton.onclick = confirmHandler;
                    batchUpdateCancelButton.onclick = cancelHandler;

                    openBatchUpdateModal();

                } else {
                    renderAllData();
                    saveSession();
                }
            } else {
                 renderAllData();
                 saveSession();
            }
        };
        
        const openBatchUpdateModal = () => {
            batchUpdateModal.classList.remove('hidden');
        }
        
        const closeBatchUpdateModal = () => {
            batchUpdateModal.classList.add('hidden');
        }

        const openConfirmModal = () => {
            confirmModal.classList.remove('hidden');
            setTimeout(() => confirmModal.querySelector('.modal-content').classList.replace('scale-95', 'scale-100'), 10);
        };

        const closeConfirmModal = () => {
            confirmModal.querySelector('.modal-content').classList.replace('scale-100', 'scale-95');
            setTimeout(() => confirmModal.classList.add('hidden'), 300);
        }

        const clearSession = () => {
            localStorage.removeItem('bookkeeperSession');
            localStorage.removeItem('bookkeeperRules');
            allData = [];
            categorizationRules = [];
            
            if(currentUser) {
                // Also clear cloud data if logged in
                saveSession();
            }
            
            dataSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            if(dateFilterContainer) dateFilterContainer.classList.add('hidden');
            fileInfo.textContent = '';
            closeConfirmModal();
             showToast('Session data cleared.');
        };
        

        const exportToIIF = () => {
            const bankAccount = bankAccountInput.value.trim();
            const defaultExpenseAccount = defaultExpenseAccountInput.value.trim();

            if (!bankAccount || !defaultExpenseAccount) {
                alert('Please enter both the QuickBooks Bank Account and Default Expense Account names before exporting.');
                return;
            }
            
            const transactionsToExport = allData.filter(d => d.type === 'transaction');

            let iifContent = `!TRNS\tTRNSID\tTRNSTYPE\tDATE\tACCNT\tNAME\tAMOUNT\tDOCNUM\tMEMO\n`;
            iifContent += `!SPL\tSPLID\tTRNSTYPE\tDATE\tACCNT\tNAME\tAMOUNT\tDOCNUM\tMEMO\n`;
            iifContent += `!ENDTRNS\n`;

            transactionsToExport.forEach((tx) => {
                const date = new Date(tx.date).toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
                const name = tx.job || tx.description.substring(0, 30).replace(/\s+/g, ' ');
                const memo = `${tx.description} ${tx.notes || ''}`.trim().substring(0, 100);
                const amount = tx.amount.toFixed(2);
                const isExpense = tx.amount < 0;
                
                const transactionType = isExpense ? 'EXPENSE' : 'DEPOSIT';
                const categoryAccount = tx.category === 'Uncategorized' ? defaultExpenseAccount : tx.category;

                iifContent += `TRNS\t\t${transactionType}\t${date}\t${bankAccount}\t${name}\t${amount}\t\t${memo}\n`;
                iifContent += `SPL\t\t${transactionType}\t${date}\t${categoryAccount}\t${name}\t${-amount}\t\t${memo}\n`;
                iifContent += `ENDTRNS\n`;
            });

            const blob = new Blob([iifContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'quickbooks_import.iif';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const updateJobDatalist = () => {
            const jobList = document.getElementById('job-list');
            const existingJobs = [...new Set(allData.map(tx => tx.job).filter(j => j))];
            jobList.innerHTML = existingJobs.map(j => `<option value="${j}"></option>`).join('');
        };

        const renderJobProfitability = (data) => {
            const jobs = {};
            data.forEach(tx => {
                if(tx.job) {
                    if (!jobs[tx.job]) {
                        jobs[tx.job] = { income: 0, expenses: 0 };
                    }
                    if (tx.amount >= 0) {
                        jobs[tx.job].income += tx.amount;
                    } else {
                        jobs[tx.job].expenses += tx.amount;
                    }
                }
            });

            jobTableBody.innerHTML = '';
            if (Object.keys(jobs).length === 0) {
                jobTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">No jobs with assigned transactions in this period.</td></tr>`;
                return;
            }

            Object.keys(jobs).sort().forEach(jobName => {
                const job = jobs[jobName];
                const net = job.income + job.expenses;
                const netClass = net >= 0 ? 'text-green-600' : 'text-red-600';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${jobName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">${formatCurrency(job.income)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">${formatCurrency(Math.abs(job.expenses))}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${netClass}">${formatCurrency(net)}</td>
                `;
                jobTableBody.appendChild(row);
            });
        };
        
         const renderReports = (transactions, arItems, apItems) => {
            renderPLReport(transactions);
            renderAgingReport('ar', arItems);
            renderAgingReport('ap', apItems);
        }
        
        const renderTaxView = (transactions) => {
            if (!transactions) return;
            
            // Filter transactions: Must NOT include Owner's Draw in Expenses
            // Logic: Income is all positive. Expense is all negative MINUS 'Owner's Draw'
            let totalIncome = 0;
            let totalExpense = 0;
            
            transactions.forEach(tx => {
                if (tx.amount >= 0) {
                    totalIncome += tx.amount;
                } else {
                    // CRITICAL: Do not count Owner's Draw as an expense for Tax Calculation
                    if (tx.category !== "Owner's Draw") {
                         totalExpense += tx.amount;
                    }
                }
            });
            
            const netProfit = totalIncome + totalExpense; // Expense is negative
            const taxRate = parseFloat(taxRateInput.value) / 100;
            const estimatedTax = Math.max(0, netProfit * taxRate);
            const quarterlyPayment = estimatedTax / 4;
            
            // Update DOM
            taxNetProfitEl.textContent = formatCurrency(netProfit);
            taxTotalDueEl.textContent = formatCurrency(estimatedTax);
            
            // Warn if 'All Years' is selected
            if (yearFilter.value === 'all') {
                taxYearWarning.classList.remove('hidden');
                [taxQ1El, taxQ2El, taxQ3El, taxQ4El].forEach(el => el.textContent = "---");
            } else {
                taxYearWarning.classList.add('hidden');
                [taxQ1El, taxQ2El, taxQ3El, taxQ4El].forEach(el => el.textContent = formatCurrency(quarterlyPayment));
            }
        };

        
        const renderPLReport = (data) => {
            const incomeByCategory = {};
            const expensesByCategory = {};
            let totalIncome = 0;
            let totalExpense = 0;

            data.forEach(tx => {
                if (tx.amount >= 0) {
                    if (!incomeByCategory[tx.category]) incomeByCategory[tx.category] = 0;
                    incomeByCategory[tx.category] += tx.amount;
                    totalIncome += tx.amount;
                } else {
                    if (!expensesByCategory[tx.category]) expensesByCategory[tx.category] = 0;
                    expensesByCategory[tx.category] += tx.amount;
                    totalExpense += tx.amount;
                }
            });

            let reportHTML = `
                <div class="space-y-6">
                    <div>
                        <h4 class="font-semibold text-lg mb-2">Income</h4>
                        <div class="divide-y divide-gray-200">
                            ${Object.keys(incomeByCategory).sort().map(cat => `
                                <div class="flex justify-between py-2">
                                    <span>${cat}</span>
                                    <span>${formatCurrency(incomeByCategory[cat])}</span>
                                </div>
                            `).join('') || `<div class="py-2 text-gray-500">No income recorded.</div>`}
                        </div>
                        <div class="flex justify-between py-2 font-bold border-t-2 mt-2">
                            <span>Total Income</span>
                            <span>${formatCurrency(totalIncome)}</span>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-semibold text-lg mb-2">Expenses</h4>
                        <div class="divide-y divide-gray-200">
                            ${Object.keys(expensesByCategory).sort().map(cat => `
                                <div class="flex justify-between py-2">
                                    <span>${cat}</span>
                                    <span>${formatCurrency(Math.abs(expensesByCategory[cat]))}</span>
                                </div>
                            `).join('') || `<div class="py-2 text-gray-500">No expenses recorded.</div>`}
                        </div>
                        <div class="flex justify-between py-2 font-bold border-t-2 mt-2">
                            <span>Total Expenses</span>
                            <span>${formatCurrency(Math.abs(totalExpense))}</span>
                        </div>
                    </div>

                    <div class="flex justify-between py-3 font-extrabold text-xl border-t-4 mt-4">
                        <span>Net Profit</span>
                        <span class="${(totalIncome + totalExpense) >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(totalIncome + totalExpense)}</span>
                    </div>
                </div>
            `;
            reportPlContent.innerHTML = reportHTML;
        };

        const renderAgingReport = (type, data) => {
            const today = new Date();
            const buckets = {
                current: [],
                '1-30': [],
                '31-60': [],
                '61-90': [],
                '90+': []
            };

            data.filter(item => item.status === 'unpaid').forEach(item => {
                const itemDate = new Date(item.date);
                const diffTime = today - itemDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays <= 0) buckets.current.push(item);
                else if (diffDays <= 30) buckets['1-30'].push(item);
                else if (diffDays <= 60) buckets['31-60'].push(item);
                else if (diffDays <= 90) buckets['61-90'].push(item);
                else buckets['90+'].push(item);
            });
            
            const generateTableHTML = (bucketData) => {
                if (bucketData.length === 0) return '<p class="text-gray-500">Nothing in this period.</p>';
                let table = '<table class="w-full text-left"><thead><tr><th class="py-2">Customer/Vendor</th><th class="py-2">#</th><th class="py-2 text-right">Amount</th></tr></thead><tbody>';
                let total = 0;
                bucketData.forEach(item => {
                    table += `<tr><td class="py-1">${item.party}</td><td class="py-1">${item.number}</td><td class="py-1 text-right">${formatCurrency(item.amount)}</td></tr>`;
                    total += item.amount;
                });
                table += `<tr class="font-bold border-t"><td class="py-2">Total</td><td></td><td class="py-2 text-right">${formatCurrency(total)}</td></tr>`;
                table += '</tbody></table>';
                return table;
            };

            const reportHTML = `
                <div class="space-y-6">
                    <div><h4 class="font-semibold text-lg mb-2">Current</h4>${generateTableHTML(buckets.current)}</div>
                    <div><h4 class="font-semibold text-lg mb-2">1-30 Days Overdue</h4>${generateTableHTML(buckets['1-30'])}</div>
                    <div><h4 class="font-semibold text-lg mb-2">31-60 Days Overdue</h4>${generateTableHTML(buckets['31-60'])}</div>
                    <div><h4 class="font-semibold text-lg mb-2">61-90 Days Overdue</h4>${generateTableHTML(buckets['61-90'])}</div>
                    <div><h4 class="font-semibold text-lg mb-2">90+ Days Overdue</h4>${generateTableHTML(buckets['90+'])}</div>
                </div>
            `;

            if (type === 'ar') {
                reportArAgingContent.innerHTML = reportHTML;
            } else {
                reportApAgingContent.innerHTML = reportHTML;
            }
        };
        
        const populateDateFilters = () => {
            const years = [...new Set(allData.map(d => {
                if (!d.date) return null;
                const date = new Date(d.date);
                return isNaN(date.getTime()) ? null : date.getFullYear();
            }).filter(Boolean))].sort().reverse();

            yearFilter.innerHTML = '<option value="all">All Years</option>';
            years.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
            });

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthFilter.innerHTML = '<option value="all">All Months</option>';
            monthNames.forEach((name, index) => {
                monthFilter.innerHTML += `<option value="${index + 1}">${name}</option>`;
            });
        };
        
         const switchView = (activeTab) => {
            Object.keys(tabs).forEach(key => {
                const tab = tabs[key];
                const view = views[key];
                if (key === activeTab) {
                    tab.classList.add('border-indigo-500', 'text-indigo-600');
                    tab.classList.remove('border-transparent', 'text-gray-500');
                    view.classList.remove('hidden');
                } else {
                    tab.classList.remove('border-indigo-500', 'text-indigo-600');
                    tab.classList.add('border-transparent', 'text-gray-500');
                    view.classList.add('hidden');
                }
            });

            const showInputs = ['transactions', 'jobs'].includes(activeTab);
            const showActionButtons = ['transactions', 'jobs', 'ar', 'ap'].includes(activeTab);
            
            if (quickbooksInputs) quickbooksInputs.style.display = showInputs ? 'grid' : 'none';
            if (actionButtonsContainer) actionButtonsContainer.style.display = showActionButtons ? 'flex' : 'none';
        };


        const openApArModal = (type, id = null) => {
            apArForm.reset();
            apArType.value = type;

            if (id) {
                // editing existing
                const item = allData.find(d => d.id === id);
                apArId.value = id;
                apArParty.value = item.party;
                apArNumber.value = item.number;
                apArDate.value = item.date;
                apArAmount.value = item.amount;
            } else {
                apArId.value = ``;
                apArDate.value = new Date().toISOString().split('T')[0];
            }

            if(type === 'ap'){
                apArModalTitle.textContent = id ? 'Edit Bill' : 'Add New Bill';
                apArPartyLabel.textContent = 'Vendor';
            } else {
                apArModalTitle.textContent = id ? 'Edit Invoice' : 'Add New Invoice';
                apArPartyLabel.textContent = 'Customer';
            }
            
            apArModal.classList.remove('hidden');
        };

        const closeApArModal = () => apArModal.classList.add('hidden');

        const saveApArItem = () => {
            const id = apArId.value || `${apArType.value}-${Date.now()}`;
            const type = apArType.value;
            const amount = parseFloat(apArAmount.value);

            const item = {
                id: id,
                type: type,
                party: apArParty.value.trim(),
                number: apArNumber.value.trim(),
                date: apArDate.value,
                amount: isNaN(amount) ? 0 : amount,
                status: 'unpaid'
            };

            const existingIndex = allData.findIndex(d => d.id === id);
            if(existingIndex > -1){
                allData[existingIndex] = item;
            } else {
                allData.push(item);
            }
            
            renderAllData();
            saveSession();
            closeApArModal();
        };

        const renderAP = (data) => {
            apTableBody.innerHTML = '';
            if(data.length === 0) {
                apTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">No bills in this period.</td></tr>`;
                return;
            }
            data.forEach(bill => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${bill.party}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${bill.number}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(bill.date).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">${formatCurrency(bill.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${bill.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${bill.status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${bill.id}" class="ap-ar-paid-btn text-green-600 hover:text-green-900 mr-4" ${bill.status === 'paid' ? 'disabled' : ''}>${bill.status === 'paid' ? 'Paid' : 'Mark Paid'}</button>
                        <button data-id="${bill.id}" class="ap-ar-edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                    </td>
                `;
                apTableBody.appendChild(row);
            });
        };

        const renderAR = (data) => {
            arTableBody.innerHTML = '';
             if(data.length === 0) {
                arTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">No invoices in this period.</td></tr>`;
                return;
            }
            data.forEach(invoice => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${invoice.party}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${invoice.number}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(invoice.date).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">${formatCurrency(invoice.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                         <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${invoice.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${invoice.status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${invoice.id}" class="ap-ar-paid-btn text-green-600 hover:text-green-900 mr-4" ${invoice.status === 'paid' ? 'disabled' : ''}>${invoice.status === 'paid' ? 'Paid' : 'Mark Paid'}</button>
                        <button data-id="${invoice.id}" class="ap-ar-edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                    </td>
                `;
                arTableBody.appendChild(row);
            });
        };

        const toggleApArStatus = (id) => {
            const item = allData.find(d => d.id === id);
            if (item) {
                item.status = item.status === 'unpaid' ? 'paid' : 'unpaid';
                renderAllData();
                saveSession();
            }
        };
        
        const toggleReconciledStatus = (id) => {
             const item = allData.find(d => d.id === id);
            if (item && item.type === 'transaction') {
                item.reconciled = !item.reconciled;
                renderAllData();
                saveSession();
            }
        };


        // --- EVENT LISTENERS ---
        // Auth Events
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        
        // File Events
        csvFileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
        invoiceCsvFileInput.addEventListener('change', (e) => handleInvoiceFileSelect(e.target.files[0]));
        
        const dropzone = csvFileInput.parentElement;
        dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('bg-gray-200'); });
        dropzone.addEventListener('dragleave', () => { dropzone.classList.remove('bg-gray-200'); });
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('bg-gray-200');
            const file = e.dataTransfer.files[0];
            if (file && file.type === "text/csv") handleFileSelect(file);
        });

        transactionTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-btn')) {
                openEditModal(e.target.dataset.id);
            }
            if (e.target.classList.contains('reconcile-checkbox')) {
                toggleReconciledStatus(e.target.dataset.id);
            }
        });

        importMoreTransactionsButton.addEventListener('click', () => csvFileInput.click());

        saveButton.addEventListener('click', saveTransaction);
        cancelButton.addEventListener('click', closeEditModal);
        
        exportButton.addEventListener('click', exportToIIF);
        yearFilter.addEventListener('change', renderAllData);
        monthFilter.addEventListener('change', renderAllData);
        
        Object.keys(tabs).forEach(key => {
            tabs[key].addEventListener('click', () => switchView(key));
        });
        
        addCategoryButton.addEventListener('click', () => categoryModal.classList.remove('hidden'));
        closeCategoryModalButton.addEventListener('click', () => categoryModal.classList.add('hidden'));
        addNewCategoryBtn.addEventListener('click', () => addCategory(newCategoryNameInput.value));
        newCategoryNameInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') addCategory(newCategoryNameInput.value); });
        categoryListContainer.addEventListener('click', (e) => { if(e.target.classList.contains('delete-category-btn')) removeCategory(e.target.dataset.category); });
        
        addInvoiceButton.addEventListener('click', () => openApArModal('ar'));
        addBillButton.addEventListener('click', () => openApArModal('ap'));
        apArSaveButton.addEventListener('click', saveApArItem);
        apArCancelButton.addEventListener('click', closeApArModal);
        
        [apTableBody, arTableBody].forEach(tbody => {
            tbody.addEventListener('click', (e) => {
                if (e.target.classList.contains('ap-ar-paid-btn')) {
                    toggleApArStatus(e.target.dataset.id);
                }
                if (e.target.classList.contains('ap-ar-edit-btn')) {
                    const item = allData.find(d => d.id === e.target.dataset.id);
                    if(item) openApArModal(item.type, item.id);
                }
            });
        });

        saveSessionButton.addEventListener('click', () => {
            saveSession();
            showToast("Data saved.");
        });
        clearSessionButton.addEventListener('click', openConfirmModal);
        confirmDeleteButton.addEventListener('click', clearSession);
        cancelDeleteButton.addEventListener('click', closeConfirmModal);

         const switchReportView = (activeReport) => {
            [reportPlContent, reportArAgingContent, reportApAgingContent].forEach(el => el.classList.add('hidden'));
            [reportTabPl, reportTabArAging, reportTabApAging].forEach(el => {
                el.classList.remove('border-indigo-500', 'text-indigo-600');
                el.classList.add('border-transparent', 'text-gray-500');
            });
            
            if (activeReport === 'pl') {
                reportPlContent.classList.remove('hidden');
                reportTabPl.classList.add('border-indigo-500', 'text-indigo-600');
            } else if (activeReport === 'ar-aging') {
                reportArAgingContent.classList.remove('hidden');
                reportTabArAging.classList.add('border-indigo-500', 'text-indigo-600');
            } else if (activeReport === 'ap-aging') {
                reportApAgingContent.classList.remove('hidden');
                reportTabApAging.classList.add('border-indigo-500', 'text-indigo-600');
            }
        };
        reportTabPl.addEventListener('click', () => switchReportView('pl'));
        reportTabArAging.addEventListener('click', () => switchReportView('ar-aging'));
        reportTabApAging.addEventListener('click', () => switchReportView('ap-aging'));


        rulesButton.addEventListener('click', () => rulesModal.classList.remove('hidden'));
        closeRulesModalButton.addEventListener('click', () => rulesModal.classList.add('hidden'));
        addRuleBtn.addEventListener('click', addRule);
        rulesListContainer.addEventListener('click', (e) => {
            if(e.target.classList.contains('delete-rule-btn')) {
                removeRule(parseInt(e.target.dataset.index));
            }
        });
        
        if(taxRateInput){
             taxRateInput.addEventListener('input', () => renderAllData());
        }

        // Search Event Listeners
        if(arSearchInput) {
            arSearchInput.addEventListener('input', (e) => {
                arSearchTerm = e.target.value;
                renderAllData();
            });
        }

        if(apSearchInput) {
            apSearchInput.addEventListener('input', (e) => {
                apSearchTerm = e.target.value;
                renderAllData();
            });
        }

        // Searchable Category Dropdown Logic
        modalCategorySearch.addEventListener('input', () => {
            const searchTerm = modalCategorySearch.value.toLowerCase();
            const filtered = categories.filter(c => c.toLowerCase().includes(searchTerm));
            modalCategoryDropdown.innerHTML = filtered.map(c => `<div class="dropdown-item" data-value="${c}">${c}</div>`).join('');
            modalCategoryDropdown.classList.remove('hidden');
        });

        modalCategorySearch.addEventListener('focus', () => {
             modalCategoryDropdown.innerHTML = categories.map(c => `<div class="dropdown-item" data-value="${c}">${c}</div>`).join('');
             modalCategoryDropdown.classList.remove('hidden');
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.searchable-dropdown')) {
                modalCategoryDropdown.classList.add('hidden');
            }
        });

        modalCategoryDropdown.addEventListener('click', (e) => {
            if (e.target.classList.contains('dropdown-item')) {
                const value = e.target.dataset.value;
                modalCategory.value = value;
                modalCategorySearch.value = value;
                modalCategoryDropdown.classList.add('hidden');
            }
        });

        // Guide Content Population
        const guideContent = [
             { title: "1. Bank Reconciliation", content: "<p class='mb-2'><strong>What it is:</strong> Comparing your bank statements against your bookkeeping records to ensure they match. This helps catch errors, fraudulent transactions, and bank fees.</p><p><strong>How to do it:</strong></p><ol class='list-decimal list-inside ml-4 space-y-1'><li>At the end of each month, get your bank statement.</li><li>Use the \"Transactions\" tab in this tool. Check the 'Rec' box for each transaction that matches your bank statement.</li><li>The 'Unreconciled' count on the dashboard will help you track your progress.</li><li>Investigate any discrepancies immediately.</li></ol>" },
            { title: "2. Job Costing & Profitability", content: "<p class='mb-2'><strong>What it is:</strong> Tracking all income and expenses associated with a specific job or customer to determine its profitability.</p><p><strong>How to do it:</strong></p><ol class='list-decimal list-inside ml-4 space-y-1'><li>In the \"Transactions\" view, click 'Edit' on each transaction.</li><li>Assign a unique \"Job/Customer Name\" to all related income (customer payments) and expenses (parts, materials, labor).</li><li>Switch to the \"Job Profitability\" tab to see a real-time summary of profit for each job.</li><li>Use this insight to adjust your pricing and identify your most profitable types of work.</li></ol>" },
            { title: "3. Accounts Payable (A/P) & Receivable (A/R)", content: "<p class='mb-2'><strong>Accounts Payable (A/P):</strong> Money you owe to suppliers. Use the 'A/P (Bills)' tab to manually enter bills you receive. Track what's been paid and what's outstanding.</p><p class='mb-2'><strong>Accounts Receivable (A/R):</strong> Money customers owe you. Use the 'A/R (Invoices)' tab to enter invoices you send out. You can also import your invoice CSV here. This helps you track who has paid and follow up on overdue amounts.</p><p><strong>Reconciliation:</strong> When you pay a bill or receive a payment, the transaction will appear in your bank feed on the 'Transactions' tab after you import your CSV. You should then mark the corresponding item in the A/P or A/R tab as 'Paid'.</p>" },
            { title: "4. Using Reports", content: "<p class='mb-2'>The 'Reports' tab provides crucial financial insights:</p><ul class='list-disc list-inside ml-4 space-y-1'><li><strong>Profit & Loss:</strong> Shows your income, expenses, and net profit for the selected period, broken down by category.</li><li><strong>A/R Aging:</strong> Shows who owes you money and how long the payment has been overdue. Use this to prioritize collection calls.</li><li><strong>A/P Aging:</strong> Shows who you owe money to and when your bills are due. Use this to manage your cash flow and pay bills on time.</li></ul>" },
            { title: "5. Inventory Management", content: "<p class='mb-2'><strong>What it is:</strong> Tracking the parts and equipment you have in stock, both in your shop and in your service vans.</p><p><strong>How to do it:</strong></p><ol class='list-decimal list-inside ml-4 space-y-1'><li>Keep a simple spreadsheet or use dedicated software to list all inventory items.</li><li>When you purchase new parts, categorize the transaction as \"Inventory Purchase\" or similar.</li><li>When you use a part on a job, note it in your job costs. This moves the cost from an asset (inventory) to an expense (Cost of Goods Sold).</li><li>Periodically count your physical inventory to ensure it matches your records.</li></ol>" },
            { title: "6. Splitting Transactions", content: "<p class='mb-2'><strong>What it is:</strong> Sometimes a single purchase needs to be divided among multiple categories or jobs (e.g., a hardware store run buys parts for two different jobs).</p><p><strong>How to handle it (manually):</strong></p><ol class='list-decimal list-inside ml-4 space-y-1'><li>Currently, this tool doesn't support automatic splitting.</li><li>The best practice is to enter the items as separate bills in the 'A/P (Bills)' tab, one for each category/job.</li><li>When the single transaction appears in your bank feed, categorize it to a 'Clearing' or 'Suspense' account.</li><li>Then, in QuickBooks, you can reconcile the single bank transaction against the multiple bills you've created.</li></ol>" }
        ];
        const accordionContainer = document.getElementById('accordion-container');
        accordionContainer.innerHTML = guideContent.map(item => `
            <div class="border rounded-lg">
                <button class="accordion-header w-full text-left p-4 bg-gray-100 hover:bg-gray-200 focus:outline-none flex justify-between items-center">
                    <span class="font-medium">${item.title}</span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div class="accordion-content p-4 border-t">${item.content}</div>
            </div>
        `).join('');

        document.getElementById('accordion-container').addEventListener('click', e => {
            const header = e.target.closest('.accordion-header');
            if (!header) return;

            const content = header.nextElementSibling;
            const icon = header.querySelector('svg');

            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                icon.style.transform = 'rotate(0deg)';
            } else {
                document.querySelectorAll('.accordion-content').forEach(el => {
                    el.style.maxHeight = null;
                    if(el.previousElementSibling.querySelector('svg')) {
                        el.previousElementSibling.querySelector('svg').style.transform = 'rotate(0deg)';
                    }
                });
                content.style.maxHeight = content.scrollHeight + "px";
                icon.style.transform = 'rotate(180deg)';
            }
        });
        
    </script>
</body>
</html>
