<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookkeeper Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .table-scrollbar::-webkit-scrollbar {
            height: 8px;
        }
        .table-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #toast {
            transform: translateX(150%);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- App Container -->
    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">

            <!-- Header -->
            <header class="mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Bookkeeper Pro</h1>
                        <p class="text-gray-500 mt-1">Organize bank transactions for QuickBooks Desktop.</p>
                    </div>
                    <a href="https://www.communitychoicecu.com/" target="_blank" class="bg-white text-indigo-600 border border-indigo-600 px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors text-sm font-semibold">
                        Go to Bank Website
                    </a>
                </div>
            </header>

            <!-- Main Content -->
            <main>
                <!-- Step 1: File Upload -->
                <div id="upload-section" class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4">Step 1: Import Transactions</h2>
                    <p class="text-gray-600 mb-4">Upload a CSV file from your bank. Or, load a previously saved session.</p>
                    <div class="flex items-center justify-center w-full">
                        <label for="csv-file" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h5l5 5v7a4 4 0 01-4 4H7z"></path></svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                                <p class="text-xs text-gray-500">CSV file (max 5MB)</p>
                            </div>
                            <input id="csv-file" type="file" class="hidden" accept=".csv" />
                        </label>
                    </div>
                    <div id="file-info" class="mt-4 text-sm text-gray-600"></div>
                </div>

                <!-- Step 2: Categorization & Export (hidden initially) -->
                <div id="data-section" class="hidden mt-8">
                    <!-- Dashboard -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
                        <div class="bg-green-50 border-l-4 border-green-500 text-green-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">TOTAL INCOME</div>
                            <div id="total-income" class="text-2xl font-bold">$0.00</div>
                        </div>
                        <div class="bg-red-50 border-l-4 border-red-500 text-red-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">TOTAL EXPENSE</div>
                            <div id="total-expense" class="text-2xl font-bold">$0.00</div>
                        </div>
                        <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">NET</div>
                            <div id="net-total" class="text-2xl font-bold">$0.00</div>
                        </div>
                         <div class="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">A/R (OWED TO YOU)</div>
                            <div id="total-ar" class="text-2xl font-bold">$0.00</div>
                        </div>
                        <div class="bg-orange-50 border-l-4 border-orange-500 text-orange-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">A/P (YOU OWE)</div>
                            <div id="total-ap" class="text-2xl font-bold">$0.00</div>
                        </div>
                        <div class="bg-purple-50 border-l-4 border-purple-500 text-purple-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">UNRECONCILED</div>
                            <div id="total-unreconciled" class="text-2xl font-bold">0</div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <div class="flex flex-col md:flex-row justify-between md:items-center mb-4">
                            <h2 class="text-xl font-semibold">Step 2: Process Transactions</h2>
                             <!-- Tab Navigation -->
                            <div class="mt-4 md:mt-0 border-b border-gray-200">
                                <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
                                    <button id="tab-transactions" class="border-indigo-500 text-indigo-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" aria-current="page">Transactions</button>
                                    <button id="tab-jobs" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Job Profitability</button>
                                    <button id="tab-ar" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">A/R (Invoices)</button>
                                    <button id="tab-ap" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">A/P (Bills)</button>
                                    <button id="tab-reports" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Reports</button>
                                    <button id="tab-guide" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Bookkeeping Guide</button>
                                </nav>
                            </div>
                        </div>
                       
                         <!-- QuickBooks Account Inputs -->
                        <div id="quickbooks-inputs" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                            <div>
                                <label for="bank-account" class="block text-sm font-medium text-gray-700">QuickBooks Bank Account</label>
                                <input type="text" id="bank-account" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Checking">
                            </div>
                            <div>
                                <label for="default-expense-account" class="block text-sm font-medium text-gray-700">Default Expense Account</label>
                                <input type="text" id="default-expense-account" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Uncategorized Expense">
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div id="action-buttons-container" class="flex flex-wrap items-center gap-4 mb-4">
                            <button id="export-button" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Export to QuickBooks (.iif)</button>
                            <button id="add-category-button" class="bg-gray-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">Manage Categories</button>
                             <button id="save-session-button" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">Save Session</button>
                            <button id="clear-session-button" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">Clear Data</button>
                            <!-- Month Filter -->
                            <div id="month-filter-container" class="ml-auto">
                                <label for="month-filter" class="sr-only">Filter by Month</label>
                                <select id="month-filter" class="block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>
                        </div>

                        <!-- Transactions View -->
                        <div id="view-transactions">
                            <!-- Transaction Table -->
                            <div class="overflow-x-auto table-scrollbar">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rec</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job/Customer</th>
                                            <th scope="col" class="relative px-6 py-3">
                                                <span class="sr-only">Edit</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="transaction-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Job Profitability View -->
                        <div id="view-jobs" class="hidden">
                             <div class="overflow-x-auto table-scrollbar">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job/Customer</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Income</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expenses</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Profit</th>
                                        </tr>
                                    </thead>
                                    <tbody id="job-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Job rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Accounts Receivable View -->
                        <div id="view-ar" class="hidden">
                            <button id="add-invoice-button" class="mb-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Add New Invoice</button>
                            <div class="overflow-x-auto table-scrollbar">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Invoice #</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="ar-table" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Accounts Payable View -->
                        <div id="view-ap" class="hidden">
                            <button id="add-bill-button" class="mb-4 bg-orange-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">Add New Bill</button>
                            <div class="overflow-x-auto table-scrollbar">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bill #</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="ap-table" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Reports View -->
                        <div id="view-reports" class="hidden">
                            <h3 class="text-xl font-semibold mb-4">Profit & Loss Statement</h3>
                            <div id="report-container" class="prose max-w-none prose-indigo">
                                <!-- P&L Report will be generated here -->
                            </div>
                        </div>


                        <!-- Bookkeeping Guide View -->
                        <div id="view-guide" class="hidden prose max-w-none prose-indigo">
                            <h3 class="text-xl font-semibold mb-4">HVAC Bookkeeping Guide</h3>
                            <div class="space-y-4" id="accordion-container">
                                <!-- Accordion items will be populated by JS -->
                            </div>
                        </div>

                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95">
            <div class="p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-2">Edit Transaction</h3>
                <p id="modal-description" class="text-sm text-gray-600 mb-4"></p>
                
                <form id="edit-form">
                    <input type="hidden" id="modal-transaction-id">
                    <div>
                        <label for="modal-category" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="modal-category" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <!-- Options will be inserted here -->
                        </select>
                    </div>
                    <div class="mt-4">
                        <label for="modal-job" class="block text-sm font-medium text-gray-700">Job/Customer Name</label>
                        <input type="text" id="modal-job" list="job-list" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-gray-300 rounded-md" placeholder="e.g., Smith Residence Install">
                        <datalist id="job-list"></datalist>
                    </div>
                    <div class="mt-4">
                        <label for="modal-notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="modal-notes" rows="3" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-gray-300 rounded-md"></textarea>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="save-button" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">Save</button>
                <button id="cancel-button" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Manage Categories Modal -->
    <div id="category-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg m-4 transform scale-95">
             <div class="p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Manage Categories</h3>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="new-category-name" placeholder="New category name" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <button id="add-new-category-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Add</button>
                </div>
                <div id="category-list" class="max-h-60 overflow-y-auto pr-2">
                    <!-- Category list will be populated here -->
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="close-category-modal" type="button" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm">Done</button>
            </div>
        </div>
    </div>

    <!-- A/P and A/R Modal -->
    <div id="ap-ar-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95">
            <div class="p-6">
                <h3 id="ap-ar-modal-title" class="text-lg font-medium leading-6 text-gray-900 mb-4">Add New Bill</h3>
                <form id="ap-ar-form">
                    <input type="hidden" id="ap-ar-id">
                    <input type="hidden" id="ap-ar-type">
                    <div>
                        <label id="ap-ar-party-label" for="ap-ar-party" class="block text-sm font-medium text-gray-700">Vendor</label>
                        <input type="text" id="ap-ar-party" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div class="mt-4">
                        <label for="ap-ar-number" class="block text-sm font-medium text-gray-700">Bill/Invoice #</label>
                        <input type="text" id="ap-ar-number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div>
                            <label for="ap-ar-date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="ap-ar-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="ap-ar-amount" class="block text-sm font-medium text-gray-700">Amount</label>
                            <input type="number" id="ap-ar-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" step="0.01">
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="ap-ar-save-button" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">Save</button>
                <button id="ap-ar-cancel-button" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>


    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95">
            <div class="p-6">
                <div class="flex items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="confirm-modal-title">Clear Session Data</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500" id="confirm-modal-body">Are you sure you want to clear all saved transaction data? This action cannot be undone.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="confirm-delete-button" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">Delete</button>
                <button id="cancel-delete-button" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md transition-transform duration-300">
        Session Saved!
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let allData = []; // Combined list of transactions, bills, and invoices
            let categories = [
                'Uncategorized', 'Income', 'Office Supplies', 'Rent', 
                'Utilities', 'Travel', 'Meals', 'Software', 'Marketing',
                'Parts & Materials', 'Inventory Purchase'
            ];

            // --- DOM ELEMENTS ---
            const csvFileInput = document.getElementById('csv-file');
            const fileInfo = document.getElementById('file-info');
            const uploadSection = document.getElementById('upload-section');
            const dataSection = document.getElementById('data-section');
            const transactionTableBody = document.getElementById('transaction-table');
            const totalIncomeEl = document.getElementById('total-income');
            const totalExpenseEl = document.getElementById('total-expense');
            const netTotalEl = document.getElementById('net-total');
            const totalAREl = document.getElementById('total-ar');
            const totalAPEl = document.getElementById('total-ap');
            const totalUnreconciledEl = document.getElementById('total-unreconciled');

            const exportButton = document.getElementById('export-button');
            const saveSessionButton = document.getElementById('save-session-button');
            const clearSessionButton = document.getElementById('clear-session-button');


            // Tab elements
            const tabs = {
                transactions: document.getElementById('tab-transactions'),
                jobs: document.getElementById('tab-jobs'),
                ar: document.getElementById('tab-ar'),
                ap: document.getElementById('tab-ap'),
                reports: document.getElementById('tab-reports'),
                guide: document.getElementById('tab-guide'),
            };
            const views = {
                transactions: document.getElementById('view-transactions'),
                jobs: document.getElementById('view-jobs'),
                ar: document.getElementById('view-ar'),
                ap: document.getElementById('view-ap'),
                reports: document.getElementById('view-reports'),
                guide: document.getElementById('view-guide'),
            };

            const jobTableBody = document.getElementById('job-table');
            const arTableBody = document.getElementById('ar-table');
            const apTableBody = document.getElementById('ap-table');
            const quickbooksInputs = document.getElementById('quickbooks-inputs');
            const actionButtonsContainer = document.getElementById('action-buttons-container');
            const reportContainer = document.getElementById('report-container');

            // Modal elements
            const editModal = document.getElementById('edit-modal');
            const modalDescription = document.getElementById('modal-description');
            const modalTransactionId = document.getElementById('modal-transaction-id');
            const modalCategory = document.getElementById('modal-category');
            const modalJob = document.getElementById('modal-job');
            const modalNotes = document.getElementById('modal-notes');
            const saveButton = document.getElementById('save-button');
            const cancelButton = document.getElementById('cancel-button');

            // Category Modal elements
            const categoryModal = document.getElementById('category-modal');
            const addCategoryButton = document.getElementById('add-category-button');
            const closeCategoryModalButton = document.getElementById('close-category-modal');
            const addNewCategoryBtn = document.getElementById('add-new-category-btn');
            const newCategoryNameInput = document.getElementById('new-category-name');
            const categoryListContainer = document.getElementById('category-list');
            
            // AP/AR Modal Elements
            const apArModal = document.getElementById('ap-ar-modal');
            const apArModalTitle = document.getElementById('ap-ar-modal-title');
            const apArForm = document.getElementById('ap-ar-form');
            const apArId = document.getElementById('ap-ar-id');
            const apArType = document.getElementById('ap-ar-type');
            const apArPartyLabel = document.getElementById('ap-ar-party-label');
            const apArParty = document.getElementById('ap-ar-party');
            const apArNumber = document.getElementById('ap-ar-number');
            const apArDate = document.getElementById('ap-ar-date');
            const apArAmount = document.getElementById('ap-ar-amount');
            const apArSaveButton = document.getElementById('ap-ar-save-button');
            const apArCancelButton = document.getElementById('ap-ar-cancel-button');
            const addInvoiceButton = document.getElementById('add-invoice-button');
            const addBillButton = document.getElementById('add-bill-button');
            
            const bankAccountInput = document.getElementById('bank-account');
            const defaultExpenseAccountInput = document.getElementById('default-expense-account');
            const monthFilter = document.getElementById('month-filter');
            const monthFilterContainer = document.getElementById('month-filter-container');

            // Confirmation Modal elements
            const confirmModal = document.getElementById('confirm-modal');
            const confirmDeleteButton = document.getElementById('confirm-delete-button');
            const cancelDeleteButton = document.getElementById('cancel-delete-button');


            // --- FUNCTIONS ---
             const showToast = (message, isError = false) => {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.toggle('bg-red-500', isError);
                toast.classList.toggle('bg-green-500', !isError);
                toast.style.transform = 'translateX(0)';
                setTimeout(() => {
                    toast.style.transform = 'translateX(150%)';
                }, 3000);
            };

            const saveSession = () => {
                if (allData.length > 0) {
                    localStorage.setItem('bookkeeperSession', JSON.stringify(allData));
                    showToast('Session saved successfully!');
                } else {
                    showToast('No data to save.', true);
                }
            };

            const openConfirmModal = () => {
                confirmModal.classList.remove('hidden');
                setTimeout(() => confirmModal.querySelector('.modal-content').classList.replace('scale-95', 'scale-100'), 10);
            };

            const closeConfirmModal = () => {
                confirmModal.querySelector('.modal-content').classList.replace('scale-100', 'scale-95');
                setTimeout(() => confirmModal.classList.add('hidden'), 300);
            }

            const clearSession = () => {
                localStorage.removeItem('bookkeeperSession');
                allData = [];
                dataSection.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                monthFilterContainer.classList.add('hidden');
                fileInfo.textContent = '';
                closeConfirmModal();
                 showToast('Session data cleared.');
            };
            
            const loadSession = () => {
                const savedSession = localStorage.getItem('bookkeeperSession');
                if (savedSession) {
                    allData = JSON.parse(savedSession);
                    if (allData.length > 0) {
                        populateMonthFilter();
                        renderAllData();
                        uploadSection.classList.add('hidden');
                        dataSection.classList.remove('hidden');
                        monthFilterContainer.classList.remove('hidden');
                    }
                }
            };


            const formatCurrency = (amount) => {
                const value = parseFloat(amount);
                return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            };
            
            const loadCategories = () => {
                const savedCategories = localStorage.getItem('bookkeeperCategories');
                if(savedCategories){
                    categories = JSON.parse(savedCategories);
                }
                populateCategoryDropdowns();
                populateCategoryManagementList();
            };

            const saveCategories = () => {
                localStorage.setItem('bookkeeperCategories', JSON.stringify(categories));
            };

            const renderAllData = () => {
                const selectedMonth = monthFilter.value;
                let filteredData;

                if (selectedMonth === 'all') {
                    filteredData = [...allData];
                } else {
                    filteredData = allData.filter(tx => {
                        const date = new Date(tx.date);
                        const year = date.getFullYear();
                        const month = date.getMonth() + 1;
                        const monthStr = `${year}-${String(month).padStart(2, '0')}`;
                        return monthStr === selectedMonth;
                    });
                }
                
                const transactions = filteredData.filter(d => d.type === 'transaction');
                const arItems = filteredData.filter(d => d.type === 'ar');
                const apItems = filteredData.filter(d => d.type === 'ap');

                renderTransactions(transactions);
                updateDashboard(transactions, arItems, apItems);
                renderJobProfitability(transactions);
                renderAR(arItems);
                renderAP(apItems);
                renderReports(transactions);
            };

            const renderTransactions = (data) => {
                transactionTableBody.innerHTML = '';
                if (data.length === 0) {
                     transactionTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">No transactions for the selected period.</td></tr>`;
                     return;
                }
                
                data.forEach(tx => {
                    const row = document.createElement('tr');
                    const amountClass = tx.amount >= 0 ? 'text-green-600' : 'text-red-600';
                    const categoryClass = tx.category === 'Uncategorized' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800';
                    row.innerHTML = `
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-center">
                            <input type="checkbox" data-id="${tx.id}" class="reconcile-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" ${tx.reconciled ? 'checked' : ''}>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(tx.date).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 max-w-xs truncate" title="${tx.description}">${tx.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${amountClass}">${formatCurrency(tx.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${categoryClass}">${tx.category}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.job || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${tx.id}" class="edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                        </td>
                    `;
                    transactionTableBody.appendChild(row);
                });
            };

            const updateDashboard = (transactions, arItems, apItems) => {
                const income = transactions.filter(tx => tx.amount >= 0).reduce((sum, tx) => sum + tx.amount, 0);
                const expense = transactions.filter(tx => tx.amount < 0).reduce((sum, tx) => sum + tx.amount, 0);
                const net = income + expense;

                const totalAR = arItems.filter(i => i.status === 'unpaid').reduce((sum, i) => sum + i.amount, 0);
                const totalAP = apItems.filter(i => i.status === 'unpaid').reduce((sum, i) => sum + i.amount, 0);
                const unreconciledCount = transactions.filter(tx => !tx.reconciled).length;

                totalIncomeEl.textContent = formatCurrency(income);
                totalExpenseEl.textContent = formatCurrency(Math.abs(expense));
                netTotalEl.textContent = formatCurrency(net);
                totalAREl.textContent = formatCurrency(totalAR);
                totalAPEl.textContent = formatCurrency(totalAP);
                totalUnreconciledEl.textContent = unreconciledCount;

                netTotalEl.parentElement.classList.toggle('bg-red-50', net < 0);
                netTotalEl.parentElement.classList.toggle('border-red-500', net < 0);
                netTotalEl.parentElement.classList.toggle('text-red-800', net < 0);
                netTotalEl.parentElement.classList.toggle('bg-green-50', net >= 0);
                netTotalEl.parentElement.classList.toggle('border-green-500', net >= 0);
                netTotalEl.parentElement.classList.toggle('text-green-800', net >= 0);
            };

            const handleFileSelect = (file) => {
                if (!file) return;
                
                fileInfo.textContent = `File: ${file.name}`;
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        let newCategoriesFound = false;
                        const importedTransactions = results.data.map((row, index) => {
                             let dateKey = Object.keys(row).find(k => k.toLowerCase().includes('date'));
                            let descriptionKey = Object.keys(row).find(k => k.toLowerCase().includes('description') || k.toLowerCase().includes('memo'));
                            let classificationKey = Object.keys(row).find(k => k.toLowerCase() === 'classification');
                            
                            let debitKey = Object.keys(row).find(k => k.toLowerCase() === 'debit');
                            let creditKey = Object.keys(row).find(k => k.toLowerCase() === 'credit');
                            let amountKey = Object.keys(row).find(k => k.toLowerCase().includes('amount'));

                            if (!dateKey || !descriptionKey) {
                                console.error('CSV must have columns for Date and Description.', row);
                                return null;
                            }
                            
                            let amount = 0;
                            if (debitKey || creditKey) {
                                const debitValue = row[debitKey] || "0";
                                const creditValue = row[creditKey] || "0";
                                const debit = parseFloat(debitValue.replace(/[^0-9.-]+/g, ""));
                                const credit = parseFloat(creditValue.replace(/[^0-9.-]+/g, ""));
                                
                                if (!isNaN(debit) && debit !== 0) amount = -debit;
                                else if (!isNaN(credit) && credit !== 0) amount = credit;
                            } else if (amountKey) {
                                const rawAmount = row[amountKey] || "0";
                                amount = parseFloat(rawAmount.replace(/[^0-9.-]+/g, ""));
                            } else {
                                console.error('CSV must have an "Amount" column or "Debit"/"Credit" columns.', row);
                                return null;
                            }
                            
                            const initialCategory = (classificationKey && row[classificationKey] && row[classificationKey].trim()) || 'Uncategorized';

                            if (initialCategory && !categories.includes(initialCategory)) {
                                categories.push(initialCategory);
                                newCategoriesFound = true;
                            }

                            return {
                                id: `tx-${Date.now()}-${index}`,
                                type: 'transaction',
                                date: new Date(row[dateKey]).toISOString().split('T')[0],
                                description: row[descriptionKey] || 'No Description',
                                amount: isNaN(amount) ? 0 : amount,
                                category: initialCategory,
                                notes: '',
                                job: '',
                                status: 'cleared', // Bank transactions are considered cleared
                                reconciled: false,
                            };
                        }).filter(Boolean); 

                        allData = [...allData.filter(d => d.type !== 'transaction'), ...importedTransactions];
                        
                        if (newCategoriesFound) {
                            categories.sort();
                            saveCategories();
                            populateCategoryDropdowns();
                            populateCategoryManagementList();
                        }

                        populateMonthFilter();
                        renderAllData();
                        
                        uploadSection.classList.add('hidden');
                        dataSection.classList.remove('hidden');
                        monthFilterContainer.classList.remove('hidden');
                    },
                    error: (error) => {
                        console.error('CSV Parsing Error:', error);
                        fileInfo.textContent = 'Error parsing CSV file. Check console for details.';
                    }
                });
            };
            
            const openEditModal = (transactionId) => {
                const tx = allData.find(t => t.id === transactionId);
                if (!tx) return;
                
                modalTransactionId.value = tx.id;
                modalDescription.textContent = tx.description;
                modalJob.value = tx.job;
                modalNotes.value = tx.notes;
                
                populateCategoryDropdowns();
                updateJobDatalist();
                modalCategory.value = tx.category;
                
                editModal.classList.remove('hidden');
                setTimeout(() => editModal.querySelector('.modal-content').classList.replace('scale-95', 'scale-100'), 10);
            };
            
            const closeEditModal = () => {
                editModal.querySelector('.modal-content').classList.replace('scale-100', 'scale-95');
                setTimeout(() => editModal.classList.add('hidden'), 300);
            };

            const saveTransaction = () => {
                const transactionId = modalTransactionId.value;
                const tx = allData.find(t => t.id === transactionId);
                if (tx) {
                    tx.category = modalCategory.value;
                    tx.job = modalJob.value.trim();
                    tx.notes = modalNotes.value;
                }
                renderAllData();
                closeEditModal();
            };

            const populateCategoryDropdowns = () => {
                modalCategory.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            };

            const populateCategoryManagementList = () => {
                 categoryListContainer.innerHTML = '';
                 categories.forEach(cat => {
                     const isProtected = ['Uncategorized'].includes(cat);
                     const item = document.createElement('div');
                     item.className = 'flex justify-between items-center p-2 rounded-md hover:bg-gray-100';
                     item.innerHTML = `
                        <span>${cat}</span>
                        ${isProtected ? '' : `<button data-category="${cat}" class="delete-category-btn text-red-500 hover:text-red-700 text-sm font-semibold">Remove</button>`}
                     `;
                     categoryListContainer.appendChild(item);
                 });
            };

            const addCategory = (name) => {
                const newCat = name.trim();
                if(newCat && !categories.includes(newCat)){
                    categories.push(newCat);
                    categories.sort();
                    saveCategories();
                    populateCategoryManagementList();
                    populateCategoryDropdowns();
                }
                newCategoryNameInput.value = '';
            };

            const removeCategory = (name) => {
                if(name === 'Uncategorized') return;
                
                categories = categories.filter(c => c !== name);
                allData.forEach(tx => {
                    if(tx.category === name) {
                        tx.category = 'Uncategorized';
                    }
                });
                
                saveCategories();
                populateCategoryManagementList();
                populateCategoryDropdowns();
                renderAllData();
            };

            const exportToIIF = () => {
                const bankAccount = bankAccountInput.value.trim();
                const defaultExpenseAccount = defaultExpenseAccountInput.value.trim();

                if (!bankAccount || !defaultExpenseAccount) {
                    alert('Please enter both the QuickBooks Bank Account and Default Expense Account names before exporting.');
                    return;
                }
                
                const transactionsToExport = allData.filter(d => d.type === 'transaction');

                let iifContent = `!TRNS\tTRNSID\tTRNSTYPE\tDATE\tACCNT\tNAME\tAMOUNT\tDOCNUM\tMEMO\n`;
                iifContent += `!SPL\tSPLID\tTRNSTYPE\tDATE\tACCNT\tNAME\tAMOUNT\tDOCNUM\tMEMO\n`;
                iifContent += `!ENDTRNS\n`;

                transactionsToExport.forEach((tx) => {
                    const date = new Date(tx.date).toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
                    const name = tx.job || tx.description.substring(0, 30).replace(/\s+/g, ' ');
                    const memo = `${tx.description} ${tx.notes || ''}`.trim().substring(0, 100);
                    const amount = tx.amount.toFixed(2);
                    const isExpense = tx.amount < 0;
                    
                    const transactionType = isExpense ? 'EXPENSE' : 'DEPOSIT';
                    const categoryAccount = tx.category === 'Uncategorized' ? defaultExpenseAccount : tx.category;

                    iifContent += `TRNS\t\t${transactionType}\t${date}\t${bankAccount}\t${name}\t${amount}\t\t${memo}\n`;
                    iifContent += `SPL\t\t${transactionType}\t${date}\t${categoryAccount}\t${name}\t${-amount}\t\t${memo}\n`;
                    iifContent += `ENDTRNS\n`;
                });

                const blob = new Blob([iifContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'quickbooks_import.iif';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const updateJobDatalist = () => {
                const jobList = document.getElementById('job-list');
                const existingJobs = [...new Set(allData.map(tx => tx.job).filter(j => j))];
                jobList.innerHTML = existingJobs.map(j => `<option value="${j}"></option>`).join('');
            };

            const renderJobProfitability = (data) => {
                const jobs = {};
                data.forEach(tx => {
                    if(tx.job) {
                        if (!jobs[tx.job]) {
                            jobs[tx.job] = { income: 0, expenses: 0 };
                        }
                        if (tx.amount >= 0) {
                            jobs[tx.job].income += tx.amount;
                        } else {
                            jobs[tx.job].expenses += tx.amount;
                        }
                    }
                });

                jobTableBody.innerHTML = '';
                if (Object.keys(jobs).length === 0) {
                    jobTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">No jobs with assigned transactions in this period.</td></tr>`;
                    return;
                }

                Object.keys(jobs).sort().forEach(jobName => {
                    const job = jobs[jobName];
                    const net = job.income + job.expenses;
                    const netClass = net >= 0 ? 'text-green-600' : 'text-red-600';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${jobName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">${formatCurrency(job.income)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">${formatCurrency(Math.abs(job.expenses))}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${netClass}">${formatCurrency(net)}</td>
                    `;
                    jobTableBody.appendChild(row);
                });
            };

            const renderReports = (data) => {
                const incomeByCategory = {};
                const expensesByCategory = {};
                let totalIncome = 0;
                let totalExpense = 0;

                data.forEach(tx => {
                    if (tx.amount >= 0) {
                        if (!incomeByCategory[tx.category]) incomeByCategory[tx.category] = 0;
                        incomeByCategory[tx.category] += tx.amount;
                        totalIncome += tx.amount;
                    } else {
                        if (!expensesByCategory[tx.category]) expensesByCategory[tx.category] = 0;
                        expensesByCategory[tx.category] += tx.amount;
                        totalExpense += tx.amount;
                    }
                });

                let reportHTML = `
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-semibold text-lg mb-2">Income</h4>
                            <div class="divide-y divide-gray-200">
                                ${Object.keys(incomeByCategory).sort().map(cat => `
                                    <div class="flex justify-between py-2">
                                        <span>${cat}</span>
                                        <span>${formatCurrency(incomeByCategory[cat])}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex justify-between py-2 font-bold border-t-2 mt-2">
                                <span>Total Income</span>
                                <span>${formatCurrency(totalIncome)}</span>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-lg mb-2">Expenses</h4>
                            <div class="divide-y divide-gray-200">
                                ${Object.keys(expensesByCategory).sort().map(cat => `
                                    <div class="flex justify-between py-2">
                                        <span>${cat}</span>
                                        <span>${formatCurrency(Math.abs(expensesByCategory[cat]))}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex justify-between py-2 font-bold border-t-2 mt-2">
                                <span>Total Expenses</span>
                                <span>${formatCurrency(Math.abs(totalExpense))}</span>
                            </div>
                        </div>

                        <div class="flex justify-between py-3 font-extrabold text-xl border-t-4 mt-4">
                            <span>Net Profit</span>
                            <span class="${(totalIncome + totalExpense) >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(totalIncome + totalExpense)}</span>
                        </div>
                    </div>
                `;
                reportContainer.innerHTML = reportHTML;
            };
            
            const populateMonthFilter = () => {
                const months = new Set();
                allData.forEach(tx => {
                    const date = new Date(tx.date);
                    if (isNaN(date.getTime())) return;
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    months.add(`${year}-${String(month).padStart(2, '0')}`);
                });

                const sortedMonths = Array.from(months).sort().reverse();
                monthFilter.innerHTML = '<option value="all">All Time</option>';
                sortedMonths.forEach(monthStr => {
                    const [year, month] = monthStr.split('-');
                    const date = new Date(year, month - 1);
                    const monthName = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                    monthFilter.innerHTML += `<option value="${monthStr}">${monthName}</option>`;
                });
            };
            
             const switchView = (activeTab) => {
                Object.keys(tabs).forEach(key => {
                    const tab = tabs[key];
                    const view = views[key];
                    if (key === activeTab) {
                        tab.classList.add('border-indigo-500', 'text-indigo-600');
                        tab.classList.remove('border-transparent', 'text-gray-500');
                        view.classList.remove('hidden');
                    } else {
                        tab.classList.remove('border-indigo-500', 'text-indigo-600');
                        tab.classList.add('border-transparent', 'text-gray-500');
                        view.classList.add('hidden');
                    }
                });

                const showInputs = ['transactions', 'jobs'].includes(activeTab);
                const showActionButtons = ['transactions', 'jobs', 'ar', 'ap'].includes(activeTab);
                
                quickbooksInputs.style.display = showInputs ? 'grid' : 'none';
                actionButtonsContainer.style.display = showActionButtons ? 'flex' : 'none';
            };


            const openApArModal = (type, id = null) => {
                apArForm.reset();
                apArType.value = type;

                if (id) {
                    // editing existing
                    const item = allData.find(d => d.id === id);
                    apArId.value = id;
                    apArParty.value = item.party;
                    apArNumber.value = item.number;
                    apArDate.value = item.date;
                    apArAmount.value = item.amount;
                } else {
                    apArId.value = ``;
                    apArDate.value = new Date().toISOString().split('T')[0];
                }

                if(type === 'ap'){
                    apArModalTitle.textContent = id ? 'Edit Bill' : 'Add New Bill';
                    apArPartyLabel.textContent = 'Vendor';
                } else {
                    apArModalTitle.textContent = id ? 'Edit Invoice' : 'Add New Invoice';
                    apArPartyLabel.textContent = 'Customer';
                }
                
                apArModal.classList.remove('hidden');
            };

            const closeApArModal = () => apArModal.classList.add('hidden');

            const saveApArItem = () => {
                const id = apArId.value || `${apArType.value}-${Date.now()}`;
                const type = apArType.value;
                const amount = parseFloat(apArAmount.value);

                const item = {
                    id: id,
                    type: type,
                    party: apArParty.value.trim(),
                    number: apArNumber.value.trim(),
                    date: apArDate.value,
                    amount: isNaN(amount) ? 0 : amount,
                    status: 'unpaid'
                };

                const existingIndex = allData.findIndex(d => d.id === id);
                if(existingIndex > -1){
                    allData[existingIndex] = item;
                } else {
                    allData.push(item);
                }
                
                renderAllData();
                closeApArModal();
            };

            const renderAP = (data) => {
                apTableBody.innerHTML = '';
                if(data.length === 0) {
                    apTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">No bills in this period.</td></tr>`;
                    return;
                }
                data.forEach(bill => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${bill.party}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${bill.number}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(bill.date).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">${formatCurrency(bill.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${bill.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${bill.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${bill.id}" class="ap-ar-paid-btn text-green-600 hover:text-green-900 mr-4" ${bill.status === 'paid' ? 'disabled' : ''}>${bill.status === 'paid' ? 'Paid' : 'Mark Paid'}</button>
                            <button data-id="${bill.id}" class="ap-ar-edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                        </td>
                    `;
                    apTableBody.appendChild(row);
                });
            };

            const renderAR = (data) => {
                arTableBody.innerHTML = '';
                 if(data.length === 0) {
                    arTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">No invoices in this period.</td></tr>`;
                    return;
                }
                data.forEach(invoice => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${invoice.party}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${invoice.number}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(invoice.date).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">${formatCurrency(invoice.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                             <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${invoice.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${invoice.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${invoice.id}" class="ap-ar-paid-btn text-green-600 hover:text-green-900 mr-4" ${invoice.status === 'paid' ? 'disabled' : ''}>${invoice.status === 'paid' ? 'Paid' : 'Mark Paid'}</button>
                            <button data-id="${invoice.id}" class="ap-ar-edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                        </td>
                    `;
                    arTableBody.appendChild(row);
                });
            };

            const toggleApArStatus = (id) => {
                const item = allData.find(d => d.id === id);
                if (item) {
                    item.status = item.status === 'unpaid' ? 'paid' : 'unpaid';
                    renderAllData();
                }
            };
            
            const toggleReconciledStatus = (id) => {
                 const item = allData.find(d => d.id === id);
                if (item && item.type === 'transaction') {
                    item.reconciled = !item.reconciled;
                    renderAllData();
                }
            };

            // --- EVENT LISTENERS ---
            csvFileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
            
            const dropzone = csvFileInput.parentElement;
            dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('bg-gray-200'); });
            dropzone.addEventListener('dragleave', () => { dropzone.classList.remove('bg-gray-200'); });
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('bg-gray-200');
                const file = e.dataTransfer.files[0];
                if (file && file.type === "text/csv") handleFileSelect(file);
            });

            transactionTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-btn')) {
                    openEditModal(e.target.dataset.id);
                }
                if (e.target.classList.contains('reconcile-checkbox')) {
                    toggleReconciledStatus(e.target.dataset.id);
                }
            });

            saveButton.addEventListener('click', saveTransaction);
            cancelButton.addEventListener('click', closeEditModal);
            
            exportButton.addEventListener('click', exportToIIF);
            monthFilter.addEventListener('change', renderAllData);
            
            Object.keys(tabs).forEach(key => {
                tabs[key].addEventListener('click', () => switchView(key));
            });
            
            addCategoryButton.addEventListener('click', () => categoryModal.classList.remove('hidden'));
            closeCategoryModalButton.addEventListener('click', () => categoryModal.classList.add('hidden'));
            addNewCategoryBtn.addEventListener('click', () => addCategory(newCategoryNameInput.value));
            newCategoryNameInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') addCategory(newCategoryNameInput.value); });
            categoryListContainer.addEventListener('click', (e) => { if(e.target.classList.contains('delete-category-btn')) removeCategory(e.target.dataset.category); });
            
            addInvoiceButton.addEventListener('click', () => openApArModal('ar'));
            addBillButton.addEventListener('click', () => openApArModal('ap'));
            apArSaveButton.addEventListener('click', saveApArItem);
            apArCancelButton.addEventListener('click', closeApArModal);
            
            [apTableBody, arTableBody].forEach(tbody => {
                tbody.addEventListener('click', (e) => {
                    if (e.target.classList.contains('ap-ar-paid-btn')) {
                        toggleApArStatus(e.target.dataset.id);
                    }
                    if (e.target.classList.contains('ap-ar-edit-btn')) {
                        const item = allData.find(d => d.id === e.target.dataset.id);
                        if(item) openApArModal(item.type, item.id);
                    }
                });
            });

            saveSessionButton.addEventListener('click', saveSession);
            clearSessionButton.addEventListener('click', openConfirmModal);
            confirmDeleteButton.addEventListener('click', clearSession);
            cancelDeleteButton.addEventListener('click', closeConfirmModal);

            const guideContent = [
                 { title: "1. Bank Reconciliation", content: "<p class='mb-2'><strong>What it is:</strong> Comparing your bank statements against your bookkeeping records to ensure they match. This helps catch errors, fraudulent transactions, and bank fees.</p><p><strong>How to do it:</strong></p><ol class='list-decimal list-inside ml-4 space-y-1'><li>At the end of each month, get your bank statement.</li><li>Use the \"Transactions\" tab in this tool. Check the 'Rec' box for each transaction that matches your bank statement.</li><li>The 'Unreconciled' count on the dashboard will help you track your progress.</li><li>Investigate any discrepancies immediately.</li></ol>" },
                { title: "2. Job Costing & Profitability", content: "<p class='mb-2'><strong>What it is:</strong> Tracking all income and expenses associated with a specific job or customer to determine its profitability.</p><p><strong>How to do it:</strong></p><ol class='list-decimal list-inside ml-4 space-y-1'><li>In the \"Transactions\" view, click 'Edit' on each transaction.</li><li>Assign a unique \"Job/Customer Name\" to all related income (customer payments) and expenses (parts, materials, labor).</li><li>Switch to the \"Job Profitability\" tab to see a real-time summary of profit for each job.</li><li>Use this insight to adjust your pricing and identify your most profitable types of work.</li></ol>" },
                { title: "3. Accounts Payable (A/P) & Receivable (A/R)", content: "<p class='mb-2'><strong>Accounts Payable (A/P):</strong> Money you owe to suppliers. Use the 'A/P (Bills)' tab to manually enter bills you receive. Track what's been paid and what's outstanding.</p><p class='mb-2'><strong>Accounts Receivable (A/R):</strong> Money customers owe you. Use the 'A/R (Invoices)' tab to enter invoices you send out. This helps you track who has paid and follow up on overdue amounts.</p><p><strong>Reconciliation:</strong> When you pay a bill or receive a payment, the transaction will appear in your bank feed on the 'Transactions' tab after you import your CSV. You should then mark the corresponding item in the A/P or A/R tab as 'Paid'.</p>" },
                { title: "4. Inventory Management", content: "<p class='mb-2'><strong>What it is:</strong> Tracking the parts and equipment you have in stock, both in your shop and in your service vans.</p><p><strong>How to do it:</strong></p><ol class='list-decimal list-inside ml-4 space-y-1'><li>Keep a simple spreadsheet or use dedicated software to list all inventory items.</li><li>When you purchase new parts, categorize the transaction as \"Inventory Purchase\" or similar.</li><li>When you use a part on a job, note it in your job costs. This moves the cost from an asset (inventory) to an expense (Cost of Goods Sold).</li><li>Periodically count your physical inventory to ensure it matches your records.</li></ol>" },
                { title: "5. Splitting Transactions", content: "<p class='mb-2'><strong>What it is:</strong> Sometimes a single purchase needs to be divided among multiple categories or jobs (e.g., a hardware store run buys parts for two different jobs).</p><p><strong>How to handle it (manually):</strong></p><ol class='list-decimal list-inside ml-4 space-y-1'><li>Currently, this tool doesn't support automatic splitting.</li><li>The best practice is to enter the items as separate bills in the 'A/P (Bills)' tab, one for each category/job.</li><li>When the single transaction appears in your bank feed, categorize it to a 'Clearing' or 'Suspense' account.</li><li>Then, in QuickBooks, you can reconcile the single bank transaction against the multiple bills you've created.</li></ol>" }
            ];
            const accordionContainer = document.getElementById('accordion-container');
            accordionContainer.innerHTML = guideContent.map(item => `
                <div class="border rounded-lg">
                    <button class="accordion-header w-full text-left p-4 bg-gray-100 hover:bg-gray-200 focus:outline-none flex justify-between items-center">
                        <span class="font-medium">${item.title}</span>
                        <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content p-4 border-t">${item.content}</div>
                </div>
            `).join('');

            document.getElementById('accordion-container').addEventListener('click', e => {
                const header = e.target.closest('.accordion-header');
                if (!header) return;

                const content = header.nextElementSibling;
                const icon = header.querySelector('svg');

                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    document.querySelectorAll('.accordion-content').forEach(el => {
                        el.style.maxHeight = null;
                        if(el.previousElementSibling.querySelector('svg')) {
                            el.previousElementSibling.querySelector('svg').style.transform = 'rotate(0deg)';
                        }
                    });
                    content.style.maxHeight = content.scrollHeight + "px";
                    icon.style.transform = 'rotate(180deg)';
                }
            });
            
            // --- INITIALIZATION ---
            loadCategories();
            loadSession();
            switchView('transactions');
        });
    </script>
</body>
</html>


