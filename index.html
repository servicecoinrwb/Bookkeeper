<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookkeeper Pro</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        /* Custom Scrollbar */
        .table-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .table-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #toast {
            transform: translateX(150%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 60;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        /* Searchable Dropdown */
        .searchable-dropdown {
            position: relative;
        }
        .dropdown-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            width: 100%;
            z-index: 20;
            max-height: 180px;
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .dropdown-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .dropdown-item:hover, .dropdown-item.active {
            background-color: #eff6ff;
            color: #1e40af;
        }
        .hidden { display: none; }

        /* Print Styles */
        @media print {
            body { background-color: white; }
            header, #cloud-status, nav, #quickbooks-inputs, #action-buttons-container, button { display: none !important; }
            #view-reports { display: block !important; }
            .prose { max-width: 100% !important; }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- App Container -->
    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">

            <!-- Header -->
            <header class="mb-8">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Bookkeeper Pro</h1>
                        <p class="text-gray-500 mt-1 text-sm">HVAC & Trade Accounting Tool</p>
                    </div>
                    
                    <!-- Auth Section -->
                    <div class="flex items-center gap-3">
                        <!-- Loading Spinner -->
                        <div id="auth-loading" class="hidden">
                            <div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-6 w-6"></div>
                        </div>

                        <!-- Guest View -->
                        <button id="login-btn" class="hidden flex items-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors text-sm font-semibold">
                            <svg class="w-4 h-4" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                            Sign In with Google
                        </button>

                        <!-- Logged In View -->
                        <div id="user-info" class="hidden flex items-center gap-3 bg-white border border-gray-200 px-3 py-1.5 rounded-full shadow-sm">
                            <img id="user-avatar" src="" alt="User" class="w-6 h-6 rounded-full">
                            <span id="user-name" class="text-sm font-medium text-gray-700 truncate max-w-[150px]"></span>
                            <button id="logout-btn" class="text-xs text-red-600 hover:text-red-800 font-semibold ml-2 hover:underline">Sign Out</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main>
                <!-- Status Bar -->
                <div id="cloud-status" class="hidden mb-4 bg-blue-50 text-blue-700 px-4 py-2 rounded-lg text-sm flex items-center gap-2 border border-blue-100">
                    <svg class="animate-spin h-4 w-4 text-blue-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Syncing data...
                </div>

                <!-- Step 1: File Upload -->
                <div id="upload-section" class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 text-center">
                    <div class="max-w-md mx-auto">
                        <div class="mb-6">
                            <div class="mx-auto h-16 w-16 bg-indigo-100 rounded-full flex items-center justify-center mb-4">
                                <svg class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h5l5 5v7a4 4 0 01-4 4H7z"/>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Import Transactions</h2>
                            <p class="text-gray-500">Upload your bank's CSV file to get started, or sign in to load your saved data.</p>
                        </div>
                        
                        <label for="csv-file" class="flex flex-col items-center justify-center w-full h-32 border-2 border-indigo-200 border-dashed rounded-xl cursor-pointer bg-indigo-50 hover:bg-indigo-100 transition-all group">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <p class="mb-1 text-sm text-indigo-700 font-medium group-hover:text-indigo-800">Click to upload CSV</p>
                                <p class="text-xs text-indigo-500">or drag and drop</p>
                            </div>
                            <input id="csv-file" type="file" class="hidden" accept=".csv" />
                        </label>
                        <div id="file-info" class="mt-4 text-sm font-medium text-gray-600 min-h-[20px]"></div>
                    </div>
                </div>

                <!-- Step 2: Main Application (hidden initially) -->
                <div id="data-section" class="hidden mt-6 space-y-6">
                    
                    <!-- Dashboard Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                        <!-- Income -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500 border-y border-r border-gray-100">
                            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Operating Income</div>
                            <div id="total-income" class="text-2xl font-bold text-gray-900 mt-1">$0.00</div>
                            <div class="text-xs text-green-600 mt-1">Sales & Services</div>
                        </div>
                        <!-- Expense -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500 border-y border-r border-gray-100">
                            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Operating Expense</div>
                            <div id="total-expense" class="text-2xl font-bold text-gray-900 mt-1">$0.00</div>
                            <div class="text-xs text-red-600 mt-1">Excludes Draws</div>
                        </div>
                        <!-- Net (Cash Flow) -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500 border-y border-r border-gray-100">
                            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Net Cash Flow</div>
                            <div id="net-total" class="text-2xl font-bold text-gray-900 mt-1">$0.00</div>
                            <div class="text-xs text-gray-500 mt-1">Bank Balance Change</div>
                        </div>
                        <!-- A/R -->
                         <div id="ar-card" class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500 border-y border-r border-gray-100">
                            <div class="flex justify-between items-start">
                                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">A/R (Invoices)</div>
                                <span id="ar-past-due-warning" class="hidden h-2 w-2 rounded-full bg-red-500 animate-pulse"></span>
                            </div>
                            <div id="total-ar" class="text-2xl font-bold text-gray-900 mt-1">$0.00</div>
                            <div class="text-xs text-yellow-600 mt-1">Owed to You</div>
                        </div>
                        <!-- A/P -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-500 border-y border-r border-gray-100">
                            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">A/P (Bills)</div>
                            <div id="total-ap" class="text-2xl font-bold text-gray-900 mt-1">$0.00</div>
                            <div class="text-xs text-orange-600 mt-1">You Owe</div>
                        </div>
                         <!-- Unreconciled -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-purple-500 border-y border-r border-gray-100">
                            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Unreconciled</div>
                            <div id="total-unreconciled" class="text-2xl font-bold text-gray-900 mt-1">0</div>
                            <div class="text-xs text-purple-600 mt-1">Items to Review</div>
                        </div>
                    </div>

                    <!-- Main Interface -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <!-- Toolbar -->
                        <div class="border-b border-gray-200 bg-gray-50 p-4">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                                <!-- Tabs -->
                                <nav class="flex space-x-1 bg-gray-200 p-1 rounded-lg overflow-x-auto max-w-full" aria-label="Tabs">
                                    <button id="tab-transactions" class="bg-white text-gray-900 shadow-sm px-3 py-1.5 rounded-md text-sm font-medium transition-all">Transactions</button>
                                    <button id="tab-jobs" class="text-gray-500 hover:text-gray-700 px-3 py-1.5 rounded-md text-sm font-medium transition-all">Jobs</button>
                                    <button id="tab-ar" class="text-gray-500 hover:text-gray-700 px-3 py-1.5 rounded-md text-sm font-medium transition-all">Invoices</button>
                                    <button id="tab-ap" class="text-gray-500 hover:text-gray-700 px-3 py-1.5 rounded-md text-sm font-medium transition-all">Bills</button>
                                    <button id="tab-reports" class="text-gray-500 hover:text-gray-700 px-3 py-1.5 rounded-md text-sm font-medium transition-all">Reports</button>
                                    <button id="tab-taxes" class="text-gray-500 hover:text-gray-700 px-3 py-1.5 rounded-md text-sm font-medium transition-all">Taxes</button>
                                    <button id="tab-guide" class="text-gray-500 hover:text-gray-700 px-3 py-1.5 rounded-md text-sm font-medium transition-all">Guide</button>
                                </nav>
                                
                                <!-- Global Date Filter -->
                                <div id="date-filter-container" class="flex gap-2">
                                    <select id="year-filter" class="block w-24 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm py-1.5"></select>
                                    <select id="month-filter" class="block w-32 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm py-1.5"></select>
                                </div>
                            </div>

                            <!-- Contextual Actions (Will update based on tab) -->
                            <div id="action-buttons-container" class="mt-4 flex flex-wrap items-center gap-2">
                                <button id="save-session-button" class="bg-green-600 text-white px-3 py-1.5 rounded-md shadow-sm hover:bg-green-700 text-sm font-medium">Save</button>
                                <button id="add-category-button" class="bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded-md shadow-sm hover:bg-gray-50 text-sm font-medium">Categories</button>
                                <button id="rules-button" class="bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded-md shadow-sm hover:bg-gray-50 text-sm font-medium">Rules</button>
                                <button id="export-button" class="bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded-md shadow-sm hover:bg-gray-50 text-sm font-medium">Export QB</button>
                                <button id="clear-session-button" class="ml-auto text-red-600 hover:text-red-800 text-sm font-medium px-2">Reset All</button>
                            </div>
                            
                            <!-- QuickBooks Config (Hidden by default unless needed) -->
                            <div id="quickbooks-inputs" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 hidden bg-white p-3 rounded-md border border-gray-200">
                                <div><label class="block text-xs font-medium text-gray-500">QuickBooks Bank Account</label><input type="text" id="bank-account" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm" placeholder="Checking"></div>
                                <div><label class="block text-xs font-medium text-gray-500">Default Expense Account</label><input type="text" id="default-expense-account" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm" placeholder="Uncategorized Expense"></div>
                            </div>
                        </div>

                        <!-- Content Area -->
                        <div class="p-0">
                            
                            <!-- TRANSACTIONS VIEW -->
                            <div id="view-transactions">
                                <div class="p-4 border-b border-gray-200 flex justify-between items-center gap-4 bg-white">
                                    <button id="import-more-transactions-button" class="text-indigo-600 hover:text-indigo-800 text-sm font-semibold">+ Import More</button>
                                    <input type="text" id="transaction-search" class="block w-full max-w-xs rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm" placeholder="Search transactions...">
                                </div>
                                <div class="overflow-x-auto table-scrollbar max-h-[600px]">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50 sticky top-0 z-10">
                                            <tr>
                                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase w-10"><input type="checkbox" id="select-all-rec" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job</th>
                                                <th class="px-4 py-3"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="transaction-table" class="bg-white divide-y divide-gray-200"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- JOBS VIEW -->
                            <div id="view-jobs" class="hidden">
                                <div class="overflow-x-auto table-scrollbar">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job Name</th>
                                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Income</th>
                                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Expenses</th>
                                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Net Profit</th>
                                            </tr>
                                        </thead>
                                        <tbody id="job-table" class="bg-white divide-y divide-gray-200"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- A/R VIEW -->
                            <div id="view-ar" class="hidden p-4">
                                <div class="flex flex-wrap items-center gap-4 mb-4">
                                    <button id="add-invoice-button" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">New Invoice</button>
                                    <label for="invoice-csv-file" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 cursor-pointer">Import CSV</label>
                                    <input type="file" id="invoice-csv-file" class="hidden" accept=".csv">
                                    <select id="ar-status-filter" class="rounded-md border-gray-300 text-sm shadow-sm"><option value="all">All</option><option value="unpaid">Unpaid</option><option value="paid">Paid</option></select>
                                    <input type="text" id="ar-search" class="ml-auto rounded-md border-gray-300 text-sm shadow-sm" placeholder="Search customer...">
                                </div>
                                <div class="overflow-x-auto table-scrollbar rounded-lg border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Inv #</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                                                <th class="px-6 py-3"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="ar-table" class="bg-white divide-y divide-gray-200"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- A/P VIEW -->
                            <div id="view-ap" class="hidden p-4">
                                <div class="flex flex-wrap items-center gap-4 mb-4">
                                    <button id="add-bill-button" class="bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-orange-700">New Bill</button>
                                    <input type="text" id="ap-search" class="ml-auto rounded-md border-gray-300 text-sm shadow-sm" placeholder="Search vendor...">
                                </div>
                                <div class="overflow-x-auto table-scrollbar rounded-lg border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bill #</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                                                <th class="px-6 py-3"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="ap-table" class="bg-white divide-y divide-gray-200"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- REPORTS VIEW -->
                            <div id="view-reports" class="hidden p-6">
                                <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4">
                                    <nav class="flex space-x-4">
                                        <button id="report-tab-pl" class="text-indigo-600 font-semibold text-sm border-b-2 border-indigo-600 pb-4 -mb-4.5">Profit & Loss</button>
                                        <button id="report-tab-vendors" class="text-gray-500 hover:text-gray-700 font-medium text-sm border-b-2 border-transparent pb-4 -mb-4.5 hover:border-gray-300">Vendor Expenses</button>
                                        <button id="report-tab-ar-aging" class="text-gray-500 hover:text-gray-700 font-medium text-sm border-b-2 border-transparent pb-4 -mb-4.5 hover:border-gray-300">A/R Aging</button>
                                    </nav>
                                    <button onclick="window.print()" class="text-gray-600 hover:text-gray-900 flex items-center gap-1 text-sm">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                        Print
                                    </button>
                                </div>
                                <div id="report-content-area" class="max-w-4xl">
                                    <div id="report-pl-content" class="space-y-4"></div>
                                    <div id="report-vendors-content" class="hidden space-y-4"></div>
                                    <div id="report-ar-aging-content" class="hidden space-y-4"></div>
                                </div>
                            </div>

                            <!-- TAXES VIEW -->
                            <div id="view-taxes" class="hidden p-6">
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-900 mb-4">Estimated Tax Liability</h3>
                                        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                                            <div class="flex justify-between items-center mb-4">
                                                <span class="text-gray-600">Taxable Net Profit</span>
                                                <span id="tax-net-profit" class="font-bold text-gray-900 text-lg">$0.00</span>
                                            </div>
                                            <div class="flex justify-between items-center mb-4">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-gray-600">Tax Rate</span>
                                                    <input type="number" id="tax-rate-input" value="30" class="w-16 rounded border-gray-300 text-sm text-right p-1" min="0" max="100">%
                                                </div>
                                                <span class="text-xs text-gray-400">(Self-Employment + Income)</span>
                                            </div>
                                            <div class="border-t border-gray-300 pt-4 flex justify-between items-center">
                                                <span class="text-gray-900 font-bold">Estimated Tax Due</span>
                                                <span id="tax-total-due" class="text-indigo-600 font-bold text-xl">$0.00</span>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-6">
                                            <h4 class="font-medium text-gray-900 mb-3">Quarterly Estimates</h4>
                                            <div id="tax-year-warning" class="hidden mb-3 text-sm text-yellow-700 bg-yellow-50 p-2 rounded">Select a specific year to see accurate dates.</div>
                                            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                                                <table class="min-w-full divide-y divide-gray-200">
                                                    <thead class="bg-gray-50">
                                                        <tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Q</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Deadline</th><th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Amount</th></tr>
                                                    </thead>
                                                    <tbody class="divide-y divide-gray-200">
                                                        <tr><td class="px-4 py-2 text-sm font-medium">Q1</td><td class="px-4 py-2 text-sm text-gray-500">Apr 15</td><td id="tax-q1" class="px-4 py-2 text-sm text-right font-medium text-gray-900">-</td></tr>
                                                        <tr><td class="px-4 py-2 text-sm font-medium">Q2</td><td class="px-4 py-2 text-sm text-gray-500">Jun 15</td><td id="tax-q2" class="px-4 py-2 text-sm text-right font-medium text-gray-900">-</td></tr>
                                                        <tr><td class="px-4 py-2 text-sm font-medium">Q3</td><td class="px-4 py-2 text-sm text-gray-500">Sep 15</td><td id="tax-q3" class="px-4 py-2 text-sm text-right font-medium text-gray-900">-</td></tr>
                                                        <tr><td class="px-4 py-2 text-sm font-medium">Q4</td><td class="px-4 py-2 text-sm text-gray-500">Jan 15</td><td id="tax-q4" class="px-4 py-2 text-sm text-right font-medium text-gray-900">-</td></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-blue-50 p-6 rounded-lg border border-blue-100">
                                        <h3 class="font-bold text-blue-900 mb-2">Tax Concepts</h3>
                                        <ul class="text-sm text-blue-800 space-y-3 list-disc list-inside">
                                            <li><strong>Owner's Draws are NOT Expenses:</strong> Paying yourself is considered a distribution of profit, not a tax deduction.</li>
                                            <li><strong>Profit is Taxable:</strong> You are taxed on the business profit (Income - Business Expenses), regardless of whether you leave the money in the business account or transfer it to your personal account.</li>
                                            <li><strong>Transfers:</strong> Moving money between accounts (e.g., Checking to Savings) is not income or expense. It's just moving money.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                             <!-- GUIDE VIEW -->
                            <div id="view-guide" class="hidden p-6 max-w-3xl mx-auto prose prose-indigo">
                                <h3>HVAC Bookkeeping Guide</h3>
                                <div id="accordion-container" class="not-prose space-y-2"></div>
                            </div>

                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95 overflow-hidden">
            <div class="p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-1">Edit Transaction</h3>
                <p id="modal-description" class="text-sm text-gray-500 mb-4 truncate"></p>
                
                <input type="hidden" id="modal-transaction-id">
                
                <div class="space-y-4">
                    <div class="searchable-dropdown">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Category</label>
                        <input type="text" id="modal-category-search" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" autocomplete="off">
                        <div id="modal-category-dropdown" class="dropdown-menu hidden"></div>
                        <input type="hidden" id="modal-category">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Job / Customer</label>
                        <input type="text" id="modal-job" list="job-list" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <datalist id="job-list"></datalist>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Notes</label>
                        <textarea id="modal-notes" rows="2" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex flex-row-reverse gap-2">
                <button id="save-button" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:text-sm">Save</button>
                <button id="cancel-button" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="category-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95 flex flex-col max-h-[80vh]">
            <div class="p-6 flex-grow overflow-hidden flex flex-col">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Manage Categories</h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="New Category Name" class="flex-grow rounded-md border-gray-300 shadow-sm text-sm">
                    <button id="add-new-category-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700">Add</button>
                </div>
                <div id="category-list" class="overflow-y-auto flex-grow border rounded-md p-2 bg-gray-50"></div>
            </div>
            <div class="bg-gray-50 px-6 py-3 text-right">
                <button id="close-category-modal" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md shadow-sm text-sm font-medium hover:bg-gray-50">Done</button>
            </div>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="rules-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl transform scale-95 flex flex-col max-h-[80vh]">
            <div class="p-6 flex-grow overflow-hidden flex flex-col">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Categorization Rules</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-4 bg-gray-50 p-3 rounded-md border border-gray-200">
                    <input type="text" id="rule-keyword" placeholder="If text contains..." class="rounded-md border-gray-300 shadow-sm text-sm">
                    <select id="rule-category" class="rounded-md border-gray-300 shadow-sm text-sm"></select>
                    <button id="add-rule-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700">Add Rule</button>
                </div>
                <div id="rules-list" class="overflow-y-auto flex-grow border rounded-md p-2"></div>
            </div>
            <div class="bg-gray-50 px-6 py-3 text-right">
                <button id="close-rules-modal" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md shadow-sm text-sm font-medium hover:bg-gray-50">Done</button>
            </div>
        </div>
    </div>

    <!-- AP/AR Modal -->
    <div id="ap-ar-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <div class="p-6">
                <h3 id="ap-ar-modal-title" class="text-lg font-bold text-gray-900 mb-4"></h3>
                <form id="ap-ar-form" class="space-y-4">
                    <input type="hidden" id="ap-ar-id"><input type="hidden" id="ap-ar-type">
                    <div><label id="ap-ar-party-label" class="block text-xs font-medium text-gray-700 mb-1"></label><input type="text" id="ap-ar-party" class="block w-full rounded-md border-gray-300 shadow-sm text-sm"></div>
                    <div><label class="block text-xs font-medium text-gray-700 mb-1">Reference #</label><input type="text" id="ap-ar-number" class="block w-full rounded-md border-gray-300 shadow-sm text-sm"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-medium text-gray-700 mb-1">Date</label><input type="date" id="ap-ar-date" class="block w-full rounded-md border-gray-300 shadow-sm text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-700 mb-1">Amount</label><input type="number" id="ap-ar-amount" step="0.01" class="block w-full rounded-md border-gray-300 shadow-sm text-sm"></div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex flex-row-reverse gap-2">
                <button id="ap-ar-save-button" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-md shadow-sm text-sm font-medium hover:bg-indigo-700">Save</button>
                <button id="ap-ar-cancel-button" class="w-full sm:w-auto bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md shadow-sm text-sm font-medium hover:bg-gray-50">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Batch Update Modal -->
    <div id="batch-update-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <div class="p-6 text-center">
                 <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 mb-4">
                    <svg class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Similar Transactions Found</h3>
                <p class="text-sm text-gray-500 mt-2" id="batch-update-body"></p>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex flex-col sm:flex-row-reverse gap-2">
                <button id="batch-update-confirm-button" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-md shadow-sm text-sm font-medium hover:bg-indigo-700">Yes, Apply to All</button>
                <button id="batch-update-cancel-button" class="w-full sm:w-auto bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md shadow-sm text-sm font-medium hover:bg-gray-50">No, Just This One</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <div class="p-6 flex items-start">
                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                </div>
                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Clear All Data?</h3>
                    <p class="text-sm text-gray-500 mt-2">Are you sure you want to delete all transactions and settings? This action cannot be undone.</p>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex flex-row-reverse gap-2">
                <button id="confirm-delete-button" class="w-full sm:w-auto bg-red-600 text-white px-4 py-2 rounded-md shadow-sm text-sm font-medium hover:bg-red-700">Delete Everything</button>
                <button id="cancel-delete-button" class="w-full sm:w-auto bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md shadow-sm text-sm font-medium hover:bg-gray-50">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg font-medium text-sm"></div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBwuxBEU2Yt-QGtCbnyOYf7sEfqjTG0agc",
            authDomain: "bookkeeper-478720.firebaseapp.com",
            projectId: "bookkeeper-478720",
            storageBucket: "bookkeeper-478720.firebasestorage.app",
            messagingSenderId: "46086691914",
            appId: "1:46086691914:web:f6e33d544943dd24ab9ab3",
            measurementId: "G-4WCP4Q5ZBZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State ---
        let currentUser = null;
        let allData = [];
        let categories = ['Income (Sales)', 'COGS - Equipment', 'COGS - Parts/Material', 'Subcontractors', 'Payroll Expenses', 'Vehicle Expenses', 'Tools', 'Permits', 'Marketing', 'Insurance', 'Office Supplies', 'Rent', 'Utilities', 'Owner\'s Draw', 'Transfer', 'Uncategorized'];
        let rules = [
            { keyword: 'Speedway', category: 'Vehicle Expenses' }, { keyword: 'Shell', category: 'Vehicle Expenses' },
            { keyword: 'Home Depot', category: 'COGS - Parts/Material' }, { keyword: 'Trane', category: 'COGS - Equipment' },
            { keyword: 'Google', category: 'Marketing' }, { keyword: 'Gusto', category: 'Payroll Expenses' }
        ];

        // --- DOM Elements ---
        const els = {
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            userInfo: document.getElementById('user-info'),
            userAvatar: document.getElementById('user-avatar'),
            userName: document.getElementById('user-name'),
            authLoading: document.getElementById('auth-loading'),
            cloudStatus: document.getElementById('cloud-status'),
            uploadSection: document.getElementById('upload-section'),
            dataSection: document.getElementById('data-section'),
            csvInput: document.getElementById('csv-file'),
            invoiceCsvInput: document.getElementById('invoice-csv-file'),
            transactionTable: document.getElementById('transaction-table'),
            jobTable: document.getElementById('job-table'),
            arTable: document.getElementById('ar-table'),
            apTable: document.getElementById('ap-table'),
            totalIncome: document.getElementById('total-income'),
            totalExpense: document.getElementById('total-expense'),
            netTotal: document.getElementById('net-total'),
            totalAr: document.getElementById('total-ar'),
            totalAp: document.getElementById('total-ap'),
            totalUnreconciled: document.getElementById('total-unreconciled'),
            tabs: document.querySelectorAll('[id^="tab-"]'),
            views: document.querySelectorAll('[id^="view-"]'),
            reportTabs: document.querySelectorAll('[id^="report-tab-"]'),
            reportContents: document.querySelectorAll('[id^="report-"][id$="-content"]'),
            yearFilter: document.getElementById('year-filter'),
            monthFilter: document.getElementById('month-filter')
        };

        // --- Initialization ---
        onAuthStateChanged(auth, async (user) => {
            els.authLoading.classList.remove('hidden');
            els.loginBtn.classList.add('hidden');
            els.userInfo.classList.add('hidden');
            
            if (user) {
                currentUser = user;
                els.userInfo.classList.remove('hidden');
                els.userAvatar.src = user.photoURL;
                els.userName.textContent = user.displayName;
                await loadSession(true);
            } else {
                currentUser = null;
                els.loginBtn.classList.remove('hidden');
                await loadSession(false);
            }
            els.authLoading.classList.add('hidden');
        });

        // --- Core Functions ---
        const loadSession = async (isCloud) => {
            if (isCloud) {
                try {
                    const docSnap = await getDoc(doc(db, 'users', currentUser.uid));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        allData = JSON.parse(data.data || '[]');
                        categories = JSON.parse(data.categories || JSON.stringify(categories));
                        rules = JSON.parse(data.rules || JSON.stringify(rules));
                    }
                } catch (e) { showToast('Error syncing cloud data', true); }
            } else {
                try {
                    const localData = localStorage.getItem('bk_data');
                    if (localData) allData = JSON.parse(localData);
                    const localCats = localStorage.getItem('bk_cats');
                    if (localCats) categories = JSON.parse(localCats);
                    const localRules = localStorage.getItem('bk_rules');
                    if (localRules) rules = JSON.parse(localRules);
                } catch(e) {}
            }
            
            initUI();
        };

        const saveSession = async () => {
            if (currentUser) {
                els.cloudStatus.classList.remove('hidden');
                try {
                    await setDoc(doc(db, 'users', currentUser.uid), {
                        data: JSON.stringify(allData),
                        categories: JSON.stringify(categories),
                        rules: JSON.stringify(rules),
                        updated: new Date()
                    });
                    els.cloudStatus.classList.add('hidden');
                } catch(e) { console.error(e); }
            } else {
                localStorage.setItem('bk_data', JSON.stringify(allData));
                localStorage.setItem('bk_cats', JSON.stringify(categories));
                localStorage.setItem('bk_rules', JSON.stringify(rules));
            }
        };

        const initUI = () => {
            if (allData.length > 0) {
                els.uploadSection.classList.add('hidden');
                els.dataSection.classList.remove('hidden');
                populateDateFilters();
                renderAll();
            } else {
                els.uploadSection.classList.remove('hidden');
                els.dataSection.classList.add('hidden');
            }
            populateDropdowns();
            renderRules();
            renderCategories();
        };

        // --- Parsing & Data Handling ---
        const handleCSV = (file) => {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    let count = 0;
                    results.data.forEach((row, idx) => {
                        // Intelligent Column Detection
                        const keys = Object.keys(row).map(k => k.toLowerCase());
                        const dateKey = Object.keys(row).find(k => k.toLowerCase().includes('date'));
                        const descKey = Object.keys(row).find(k => k.toLowerCase().includes('description') || k.toLowerCase().includes('memo') || k.toLowerCase().includes('name'));
                        let amount = 0;
                        
                        // Debit/Credit Handling
                        const debKey = Object.keys(row).find(k => k.toLowerCase() === 'debit');
                        const credKey = Object.keys(row).find(k => k.toLowerCase() === 'credit');
                        const amtKey = Object.keys(row).find(k => k.toLowerCase().includes('amount'));

                        if (debKey && credKey) {
                            const d = parseFloat((row[debKey] || '0').replace(/[^0-9.-]/g, ''));
                            const c = parseFloat((row[credKey] || '0').replace(/[^0-9.-]/g, ''));
                            if (d) amount = -Math.abs(d);
                            else if (c) amount = Math.abs(c);
                        } else if (amtKey) {
                            amount = parseFloat((row[amtKey] || '0').replace(/[^0-9.-]/g, ''));
                        }

                        if (dateKey && descKey && amount !== 0) {
                            const desc = row[descKey];
                            const date = new Date(row[dateKey]);
                            if (!isNaN(date)) {
                                const id = `${date.getTime()}-${Math.abs(amount)}-${idx}`;
                                if (!allData.find(d => d.id === id)) {
                                    let cat = 'Uncategorized';
                                    rules.forEach(r => {
                                        if (desc.toLowerCase().includes(r.keyword.toLowerCase())) cat = r.category;
                                    });
                                    
                                    allData.push({
                                        id, type: 'transaction', date: date.toISOString().split('T')[0],
                                        description: desc, amount, category: cat,
                                        reconciled: false, job: '', notes: ''
                                    });
                                    count++;
                                }
                            }
                        }
                    });
                    
                    if (count > 0) {
                        saveSession();
                        initUI();
                        showToast(`Imported ${count} transactions.`);
                    } else {
                        showToast('No new transactions found.', true);
                    }
                }
            });
        };

        const handleInvoiceCSV = (file) => {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    let count = 0;
                    results.data.forEach((row, idx) => {
                         const id = `inv-${Date.now()}-${idx}`;
                         // Simple field mapping - adjusts to basic CSV structures
                         const date = row['Date'] || row['TransDate'];
                         const num = row['Num'] || row['Invoice #'] || row['INVNum'];
                         const party = row['Name'] || row['Customer'];
                         const amount = parseFloat((row['Amount'] || row['Total'] || '0').replace(/[^0-9.-]/g, ''));
                         
                         if(date && party && amount) {
                             allData.push({
                                 id, type: 'ar', date: new Date(date).toISOString().split('T')[0],
                                 number: num || 'N/A', party, amount, status: 'unpaid'
                             });
                             count++;
                         }
                    });
                    if (count > 0) { saveSession(); initUI(); showToast(`Imported ${count} invoices.`); }
                }
            });
        };

        // --- Rendering ---
        const renderAll = () => {
            const y = els.yearFilter.value;
            const m = els.monthFilter.value;
            
            // Filter Data
            const filtered = allData.filter(d => {
                const date = new Date(d.date);
                if (y !== 'all' && date.getFullYear().toString() !== y) return false;
                if (m !== 'all' && (date.getMonth() + 1).toString() !== m) return false;
                return true;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            // Split Types
            const txs = filtered.filter(d => d.type === 'transaction');
            const ar = filtered.filter(d => d.type === 'ar');
            const ap = filtered.filter(d => d.type === 'ap');

            // Apply Search Filters
            const txSearch = document.getElementById('transaction-search').value.toLowerCase();
            const txsVisible = txs.filter(t => !txSearch || t.description.toLowerCase().includes(txSearch) || t.amount.toString().includes(txSearch));

            // Dashboard Math
            // Operating Income: Positive transactions, excluding Transfers
            const inc = txs.filter(t => t.amount > 0 && t.category !== 'Transfer').reduce((sum, t) => sum + t.amount, 0);
            
            // Operating Expense: Negative transactions, excluding Draws & Transfers
            const exp = txs.filter(t => t.amount < 0 && t.category !== 'Owner\'s Draw' && t.category !== 'Transfer').reduce((sum, t) => sum + t.amount, 0);
            
            // Net Cash Flow: Everything (matches bank)
            const net = txs.reduce((sum, t) => sum + t.amount, 0);

            els.totalIncome.textContent = fmtMoney(inc);
            els.totalExpense.textContent = fmtMoney(Math.abs(exp));
            els.netTotal.textContent = fmtMoney(net);
            
            els.totalAr.textContent = fmtMoney(ar.filter(i => i.status === 'unpaid').reduce((s,i) => s + i.amount, 0));
            els.totalAp.textContent = fmtMoney(ap.filter(i => i.status === 'unpaid').reduce((s,i) => s + i.amount, 0));
            els.totalUnreconciled.textContent = txs.filter(t => !t.reconciled).length;

            renderTransactions(txsVisible);
            renderJobs(txs);
            renderAR(ar);
            renderAP(ap);
            renderReports(txs, ar, ap);
            renderTaxes(txs); // Use tax-specific logic
        };

        const renderTransactions = (data) => {
            els.transactionTable.innerHTML = data.map(t => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-3 py-4 text-center"><input type="checkbox" ${t.reconciled ? 'checked' : ''} onchange="window.toggleRec('${t.id}')" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></td>
                    <td class="px-6 py-4 text-sm text-gray-500 whitespace-nowrap">${t.date}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 font-medium max-w-xs truncate" title="${t.description}">${t.description}</td>
                    <td class="px-6 py-4 text-sm font-bold text-right ${t.amount >= 0 ? 'text-green-600' : 'text-red-600'}">${fmtMoney(t.amount)}</td>
                    <td class="px-6 py-4 text-sm whitespace-nowrap"><span class="px-2 py-1 rounded-full text-xs font-semibold ${t.category === 'Uncategorized' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-700'}">${t.category}</span></td>
                    <td class="px-6 py-4 text-sm text-gray-500 whitespace-nowrap">${t.job || '-'}</td>
                    <td class="px-4 py-4 text-right"><button onclick="window.editTx('${t.id}')" class="text-indigo-600 hover:text-indigo-900 text-sm font-medium">Edit</button></td>
                </tr>
            `).join('') || '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">No transactions found.</td></tr>';
        };

        const renderVendorReport = (txs) => {
            // Logic: Exclude Income, Draws, Transfers. Group by Normalized Name.
            const vendorMap = {};
            let totalSpend = 0;
            
            txs.forEach(t => {
                if(t.amount < 0 && t.category !== 'Owner\'s Draw' && t.category !== 'Transfer') {
                    // Clean Name: Remove end numbers like "Store #455" or "0553"
                    let name = t.description.replace(/(\s#?|#)\d+$/, '').trim(); 
                    if (!vendorMap[name]) vendorMap[name] = 0;
                    vendorMap[name] += Math.abs(t.amount);
                    totalSpend += Math.abs(t.amount);
                }
            });

            const sorted = Object.entries(vendorMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 50); // Top 50

            const html = `
                <h4 class="font-bold text-gray-900 text-lg mb-4">Top Vendor Expenses</h4>
                <div class="overflow-hidden border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-1/3">Distribution</th></tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${sorted.map(([name, amount]) => {
                                const percent = ((amount / totalSpend) * 100).toFixed(1);
                                return `
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${name}</td>
                                        <td class="px-4 py-3 text-sm text-gray-500 text-right">${fmtMoney(amount)}</td>
                                        <td class="px-4 py-3">
                                            <div class="flex items-center gap-2">
                                                <div class="flex-grow bg-gray-100 rounded-full h-2">
                                                    <div class="bg-indigo-600 h-2 rounded-full" style="width: ${percent}%"></div>
                                                </div>
                                                <span class="text-xs text-gray-500 w-10 text-right">${percent}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('report-vendors-content').innerHTML = html;
        };

        const renderReports = (txs, ar, ap) => {
            // P&L Logic
            const inc = {}, exp = {};
            let totInc = 0, totExp = 0;
            txs.forEach(t => {
                if (t.category === 'Transfer') return;
                if (t.amount > 0) {
                    inc[t.category] = (inc[t.category] || 0) + t.amount;
                    totInc += t.amount;
                } else {
                    exp[t.category] = (exp[t.category] || 0) + t.amount;
                    totExp += t.amount;
                }
            });

            const plHtml = `
                <div class="space-y-6">
                    <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                        <h4 class="font-bold text-green-900 mb-3">Income</h4>
                        ${Object.entries(inc).map(([k,v]) => `<div class="flex justify-between text-sm py-1 border-b border-green-100 last:border-0 text-green-800"><span>${k}</span><span>${fmtMoney(v)}</span></div>`).join('')}
                        <div class="flex justify-between font-bold text-green-900 mt-2 pt-2 border-t border-green-200"><span>Total Income</span><span>${fmtMoney(totInc)}</span></div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                        <h4 class="font-bold text-red-900 mb-3">Expenses</h4>
                        ${Object.entries(exp).map(([k,v]) => `<div class="flex justify-between text-sm py-1 border-b border-red-100 last:border-0 text-red-800"><span>${k}</span><span>${fmtMoney(Math.abs(v))}</span></div>`).join('')}
                        <div class="flex justify-between font-bold text-red-900 mt-2 pt-2 border-t border-red-200"><span>Total Expenses</span><span>${fmtMoney(Math.abs(totExp))}</span></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex justify-between items-center">
                        <span class="font-bold text-gray-900 text-lg">Net Profit</span>
                        <span class="font-bold text-lg ${totInc + totExp >= 0 ? 'text-green-600' : 'text-red-600'}">${fmtMoney(totInc + totExp)}</span>
                    </div>
                </div>
            `;
            document.getElementById('report-pl-content').innerHTML = plHtml;

            // Vendor Report (New Logic)
            renderVendorReport(txs);

            // Aging Reports
            const renderAging = (items, type) => {
                const now = new Date();
                const buckets = { current: [], overdue: [] };
                items.filter(i => i.status === 'unpaid').forEach(i => {
                    const diff = Math.ceil((now - new Date(i.date)) / (1000 * 60 * 60 * 24));
                    if(diff > 30) buckets.overdue.push(i);
                    else buckets.current.push(i);
                });
                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="border rounded-lg p-4">
                            <h5 class="font-bold text-gray-700 mb-2">Current (0-30 Days)</h5>
                            ${buckets.current.length ? buckets.current.map(i => `<div class="flex justify-between text-sm py-1"><span>${i.party}</span><span>${fmtMoney(i.amount)}</span></div>`).join('') : '<p class="text-sm text-gray-400">None</p>'}
                        </div>
                         <div class="border rounded-lg p-4 bg-red-50 border-red-100">
                            <h5 class="font-bold text-red-700 mb-2">Overdue (30+ Days)</h5>
                            ${buckets.overdue.length ? buckets.overdue.map(i => `<div class="flex justify-between text-sm py-1 text-red-800"><span>${i.party}</span><span>${fmtMoney(i.amount)}</span></div>`).join('') : '<p class="text-sm text-gray-400">None</p>'}
                        </div>
                    </div>
                `;
            };
            document.getElementById('report-ar-aging-content').innerHTML = renderAging(ar);
        };

        const renderJobs = (txs) => {
            const jobs = {};
            txs.forEach(t => {
                if (t.job) {
                    if (!jobs[t.job]) jobs[t.job] = { inc: 0, exp: 0 };
                    if (t.amount > 0) jobs[t.job].inc += t.amount;
                    else jobs[t.job].exp += t.amount;
                }
            });
            els.jobTable.innerHTML = Object.entries(jobs).map(([k,v]) => `
                <tr>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${k}</td>
                    <td class="px-6 py-4 text-sm text-right text-green-600">${fmtMoney(v.inc)}</td>
                    <td class="px-6 py-4 text-sm text-right text-red-600">${fmtMoney(Math.abs(v.exp))}</td>
                    <td class="px-6 py-4 text-sm text-right font-bold ${v.inc + v.exp >= 0 ? 'text-green-600' : 'text-red-600'}">${fmtMoney(v.inc + v.exp)}</td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">No job data found.</td></tr>';
        };

        const renderAR = (data) => renderApArTable(data, els.arTable, 'ar');
        const renderAP = (data) => renderApArTable(data, els.apTable, 'ap');

        const renderApArTable = (data, el, type) => {
            el.innerHTML = data.map(i => `
                <tr>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${i.party}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${i.number}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${i.date}</td>
                    <td class="px-6 py-4 text-sm text-right font-medium">${fmtMoney(i.amount)}</td>
                    <td class="px-6 py-4 text-center"><span class="px-2 py-1 text-xs rounded-full font-semibold ${i.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${i.status}</span></td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="window.toggleStatus('${i.id}')" class="text-sm text-blue-600 hover:text-blue-900 mr-3">${i.status === 'paid' ? 'Mark Unpaid' : 'Mark Paid'}</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">No items found.</td></tr>';
        };

        const renderTaxes = (txs) => {
            // TAX LOGIC: Exclude Draws and Transfers from expenses. Exclude Transfers from income.
            let taxInc = 0;
            let taxExp = 0;
            
            txs.forEach(t => {
                if (t.amount > 0) {
                    if (t.category !== 'Transfer') taxInc += t.amount;
                } else {
                    if (t.category !== 'Owner\'s Draw' && t.category !== 'Transfer') taxExp += t.amount;
                }
            });

            const netProfit = taxInc + taxExp;
            const rate = parseFloat(document.getElementById('tax-rate-input').value) / 100;
            const taxDue = Math.max(0, netProfit * rate);
            const qPayment = taxDue / 4;

            document.getElementById('tax-net-profit').textContent = fmtMoney(netProfit);
            document.getElementById('tax-total-due').textContent = fmtMoney(taxDue);

            const isSpecificYear = els.yearFilter.value !== 'all';
            document.getElementById('tax-year-warning').classList.toggle('hidden', isSpecificYear);
            ['q1','q2','q3','q4'].forEach(q => document.getElementById(`tax-${q}`).textContent = isSpecificYear ? fmtMoney(qPayment) : '-');
        };

        // --- Utils ---
        const fmtMoney = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n);
        const showToast = (msg, err = false) => {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `fixed top-5 right-5 py-3 px-6 rounded-lg shadow-lg font-medium text-sm text-white ${err ? 'bg-red-600' : 'bg-gray-900'}`;
            t.style.transform = 'translateX(0)';
            setTimeout(() => t.style.transform = 'translateX(150%)', 3000);
        };
        const populateDateFilters = () => {
            const years = [...new Set(allData.map(d => d.date.substring(0,4)))].sort().reverse();
            els.yearFilter.innerHTML = `<option value="all">All Years</option>${years.map(y => `<option value="${y}">${y}</option>`).join('')}`;
            els.monthFilter.innerHTML = `<option value="all">All Months</option>${Array.from({length:12}, (_,i) => `<option value="${i+1}">${new Date(0,i).toLocaleString('default',{month:'long'})}</option>`).join('')}`;
        };
        const populateDropdowns = () => {
             const html = categories.map(c => `<option value="${c}">${c}</option>`).join('');
             document.getElementById('rule-category').innerHTML = html;
             document.getElementById('modal-category-dropdown').innerHTML = categories.map(c => `<div class="dropdown-item" onclick="window.selectCat('${c}')">${c}</div>`).join('');
        };
        const renderRules = () => {
             document.getElementById('rules-list').innerHTML = rules.map((r,i) => `
                <div class="flex justify-between items-center p-2 border-b text-sm">
                    <span>Contains "<b>${r.keyword}</b>" &rarr; ${r.category}</span>
                    <button onclick="window.delRule(${i})" class="text-red-500 hover:text-red-700">Ã—</button>
                </div>
             `).join('');
        };
        const renderCategories = () => {
            document.getElementById('category-list').innerHTML = categories.map(c => `
                <div class="flex justify-between items-center p-2 border-b text-sm last:border-0">
                    <span>${c}</span>
                    ${!['Uncategorized', 'Owner\'s Draw', 'Transfer'].includes(c) ? `<button onclick="window.delCat('${c}')" class="text-red-500 hover:text-red-700">Ã—</button>` : ''}
                </div>
            `).join('');
        };

        // --- Event Listeners ---
        els.loginBtn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        els.logoutBtn.onclick = () => signOut(auth);
        els.csvInput.onchange = (e) => handleCSV(e.target.files[0]);
        els.invoiceCsvInput.onchange = (e) => handleInvoiceCSV(e.target.files[0]);
        
        els.tabs.forEach(t => t.onclick = () => {
            els.tabs.forEach(b => b.classList.replace('bg-white', 'text-gray-500'));
            els.tabs.forEach(b => b.classList.replace('text-gray-900', 'text-gray-500'));
            els.tabs.forEach(b => b.classList.remove('shadow-sm'));
            
            t.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
            t.classList.remove('text-gray-500');
            
            els.views.forEach(v => v.classList.add('hidden'));
            document.getElementById(t.id.replace('tab-', 'view-')).classList.remove('hidden');
        });

        els.reportTabs.forEach(t => t.onclick = () => {
            els.reportTabs.forEach(b => { b.classList.remove('border-indigo-600', 'text-indigo-600'); b.classList.add('border-transparent'); });
            t.classList.add('border-indigo-600', 'text-indigo-600');
            t.classList.remove('border-transparent');
            els.reportContents.forEach(c => c.classList.add('hidden'));
            document.getElementById(t.id.replace('tab', 'content')).classList.remove('hidden');
        });

        // Search Filters
        document.getElementById('transaction-search').oninput = renderAll;
        document.getElementById('ar-search').oninput = renderAll;
        document.getElementById('ap-search').oninput = renderAll;
        els.yearFilter.onchange = renderAll;
        els.monthFilter.onchange = renderAll;
        document.getElementById('tax-rate-input').oninput = () => renderTaxes(allData.filter(d => d.type === 'transaction')); // Update taxes real-time

        // Modal Controls
        window.editTx = (id) => {
            const tx = allData.find(t => t.id === id);
            document.getElementById('modal-transaction-id').value = id;
            document.getElementById('modal-description').textContent = tx.description;
            document.getElementById('modal-category-search').value = tx.category;
            document.getElementById('modal-category').value = tx.category;
            document.getElementById('modal-job').value = tx.job;
            document.getElementById('modal-notes').value = tx.notes;
            
            // Populate Datalist
            const jobs = [...new Set(allData.map(t => t.job).filter(j => j))];
            document.getElementById('job-list').innerHTML = jobs.map(j => `<option value="${j}">`).join('');
            
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.toggleRec = (id) => {
            const tx = allData.find(t => t.id === id);
            if(tx) { tx.reconciled = !tx.reconciled; saveSession(); renderAll(); }
        };

        window.selectCat = (cat) => {
            document.getElementById('modal-category').value = cat;
            document.getElementById('modal-category-search').value = cat;
            document.getElementById('modal-category-dropdown').classList.add('hidden');
        };
        
        document.getElementById('modal-category-search').onfocus = () => document.getElementById('modal-category-dropdown').classList.remove('hidden');
        document.getElementById('save-button').onclick = () => {
            const id = document.getElementById('modal-transaction-id').value;
            const tx = allData.find(t => t.id === id);
            if (tx) {
                const newCat = document.getElementById('modal-category-search').value;
                const oldCat = tx.category;
                tx.category = newCat;
                tx.job = document.getElementById('modal-job').value;
                tx.notes = document.getElementById('modal-notes').value;
                
                document.getElementById('edit-modal').classList.add('hidden');
                
                // Batch Update Logic
                if (oldCat !== newCat) {
                    const similar = allData.filter(t => t.type === 'transaction' && t.id !== id && t.category === 'Uncategorized' && t.description.toLowerCase().includes(tx.description.substr(0, 10).toLowerCase()));
                    if (similar.length > 0) {
                        document.getElementById('batch-update-body').textContent = `Found ${similar.length} other uncategorized transactions like "${tx.description}". Categorize them all as "${newCat}"?`;
                        document.getElementById('batch-update-modal').classList.remove('hidden');
                        document.getElementById('batch-update-confirm-button').onclick = () => {
                            similar.forEach(t => t.category = newCat);
                            saveSession(); renderAll(); document.getElementById('batch-update-modal').classList.add('hidden');
                        };
                    } else { saveSession(); renderAll(); }
                } else { saveSession(); renderAll(); }
            }
        };

        document.getElementById('cancel-button').onclick = () => document.getElementById('edit-modal').classList.add('hidden');
        document.getElementById('batch-update-cancel-button').onclick = () => { document.getElementById('batch-update-modal').classList.add('hidden'); saveSession(); renderAll(); };

        // Category & Rules Management
        document.getElementById('add-category-button').onclick = () => document.getElementById('category-modal').classList.remove('hidden');
        document.getElementById('close-category-modal').onclick = () => document.getElementById('category-modal').classList.add('hidden');
        document.getElementById('add-new-category-btn').onclick = () => {
            const val = document.getElementById('new-category-name').value.trim();
            if(val && !categories.includes(val)) { categories.push(val); categories.sort(); renderCategories(); populateDropdowns(); saveSession(); document.getElementById('new-category-name').value = ''; }
        };
        window.delCat = (cat) => { categories = categories.filter(c => c !== cat); renderCategories(); populateDropdowns(); saveSession(); };

        document.getElementById('rules-button').onclick = () => document.getElementById('rules-modal').classList.remove('hidden');
        document.getElementById('close-rules-modal').onclick = () => document.getElementById('rules-modal').classList.add('hidden');
        document.getElementById('add-rule-btn').onclick = () => {
            const k = document.getElementById('rule-keyword').value.trim();
            const c = document.getElementById('rule-category').value;
            if(k && c) { rules.push({keyword: k, category: c}); renderRules(); saveSession(); document.getElementById('rule-keyword').value = ''; }
        };
        window.delRule = (idx) => { rules.splice(idx, 1); renderRules(); saveSession(); };

        // Clear Data
        document.getElementById('clear-session-button').onclick = () => document.getElementById('confirm-modal').classList.remove('hidden');
        document.getElementById('cancel-delete-button').onclick = () => document.getElementById('confirm-modal').classList.add('hidden');
        document.getElementById('confirm-delete-button').onclick = () => {
            allData = []; categories = JSON.parse(localStorage.getItem('bk_cats') || '[]'); rules = JSON.parse(localStorage.getItem('bk_rules') || '[]');
            saveSession(); initUI(); document.getElementById('confirm-modal').classList.add('hidden');
        };

        // Initial Load
        initUI();

        // Guide Content
        const guideData = [
            { t: "1. Bank Reconciliation", d: "Compare your bank statement to the Transactions tab. Check the box next to matching items. The 'Unreconciled' count shows remaining items." },
            { t: "2. Job Costing", d: "Edit transactions to assign them to a Job. The 'Jobs' tab will then show you Profit/Loss per specific project." },
            { t: "3. Tax Concepts", d: "Remember: Transfers and Owner's Draws are not expenses. Your tax liability is based on Operating Profit." }
        ];
        document.getElementById('accordion-container').innerHTML = guideData.map(g => `
            <div class="border rounded-lg mb-2 overflow-hidden">
                <button onclick="this.nextElementSibling.classList.toggle('hidden')" class="w-full text-left p-4 bg-gray-50 font-medium flex justify-between">${g.t} <span>+</span></button>
                <div class="p-4 hidden bg-white text-gray-600">${g.d}</div>
            </div>
        `).join('');

    </script>
</body>
</html>
