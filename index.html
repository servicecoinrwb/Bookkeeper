<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookkeeper Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .table-scrollbar::-webkit-scrollbar {
            height: 8px;
        }
        .table-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #toast {
            transform: translateX(150%);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- App Container -->
    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">

            <!-- Header -->
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Bookkeeper Pro</h1>
                <p class="text-gray-500 mt-1">Organize bank transactions for QuickBooks Desktop.</p>
            </header>

            <!-- Main Content -->
            <main>
                <!-- Step 1: File Upload -->
                <div id="upload-section" class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4">Step 1: Import Transactions</h2>
                    <p class="text-gray-600 mb-4">Upload a CSV file from your bank. Or, load a previously saved session.</p>
                    <div class="flex items-center justify-center w-full">
                        <label for="csv-file" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h5l5 5v7a4 4 0 01-4 4H7z"></path></svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                                <p class="text-xs text-gray-500">CSV file (max 5MB)</p>
                            </div>
                            <input id="csv-file" type="file" class="hidden" accept=".csv" />
                        </label>
                    </div>
                    <div id="file-info" class="mt-4 text-sm text-gray-600"></div>
                </div>

                <!-- Step 2: Categorization & Export (hidden initially) -->
                <div id="data-section" class="hidden mt-8">
                    <!-- Dashboard -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-green-50 border-l-4 border-green-500 text-green-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">TOTAL INCOME</div>
                            <div id="total-income" class="text-2xl font-bold">$0.00</div>
                        </div>
                        <div class="bg-red-50 border-l-4 border-red-500 text-red-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">TOTAL EXPENSE</div>
                            <div id="total-expense" class="text-2xl font-bold">$0.00</div>
                        </div>
                        <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">NET</div>
                            <div id="net-total" class="text-2xl font-bold">$0.00</div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <div class="flex flex-col md:flex-row justify-between md:items-center mb-4">
                            <h2 class="text-xl font-semibold">Step 2: Process Transactions</h2>
                             <!-- Tab Navigation -->
                            <div class="mt-4 md:mt-0 border-b border-gray-200">
                                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                    <button id="tab-transactions" class="border-indigo-500 text-indigo-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" aria-current="page">Transactions</button>
                                    <button id="tab-jobs" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Job Profitability</button>
                                    <button id="tab-guide" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">Bookkeeping Guide</button>
                                </nav>
                            </div>
                        </div>
                       
                         <!-- QuickBooks Account Inputs -->
                        <div id="quickbooks-inputs" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                            <div>
                                <label for="bank-account" class="block text-sm font-medium text-gray-700">QuickBooks Bank Account</label>
                                <input type="text" id="bank-account" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Checking">
                            </div>
                            <div>
                                <label for="default-expense-account" class="block text-sm font-medium text-gray-700">Default Expense Account</label>
                                <input type="text" id="default-expense-account" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Uncategorized Expense">
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <button id="export-button" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Export to QuickBooks (.iif)</button>
                            <button id="add-category-button" class="bg-gray-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">Manage Categories</button>
                             <button id="save-session-button" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">Save Session</button>
                            <button id="clear-session-button" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">Clear Data</button>
                            <!-- Month Filter -->
                            <div id="month-filter-container" class="ml-auto hidden">
                                <label for="month-filter" class="sr-only">Filter by Month</label>
                                <select id="month-filter" class="block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>
                        </div>

                        <!-- Transactions View -->
                        <div id="view-transactions">
                            <!-- Transaction Table -->
                            <div class="overflow-x-auto table-scrollbar">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job/Customer</th>
                                            <th scope="col" class="relative px-6 py-3">
                                                <span class="sr-only">Edit</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="transaction-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Job Profitability View -->
                        <div id="view-jobs" class="hidden">
                             <div class="overflow-x-auto table-scrollbar">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job/Customer</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Income</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expenses</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Profit</th>
                                        </tr>
                                    </thead>
                                    <tbody id="job-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Job rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Bookkeeping Guide View -->
                        <div id="view-guide" class="hidden prose max-w-none prose-indigo">
                            <h3 class="text-xl font-semibold mb-4">HVAC Bookkeeping Guide</h3>
                            <div class="space-y-4" id="accordion-container">
                                <!-- Accordion Item 1 -->
                                <div class="border rounded-lg">
                                    <button class="accordion-header w-full text-left p-4 bg-gray-100 hover:bg-gray-200 focus:outline-none flex justify-between items-center">
                                        <span class="font-medium">1. Bank Reconciliation</span>
                                        <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content p-4 border-t">
                                        <p class="mb-2"><strong>What it is:</strong> Comparing your bank statements against your bookkeeping records to ensure they match. This helps catch errors, fraudulent transactions, and bank fees.</p>
                                        <p><strong>How to do it:</strong></p>
                                        <ol class="list-decimal list-inside ml-4 space-y-1">
                                            <li>At the end of each month, get your bank statement.</li>
                                            <li>Use the "Transactions" tab in this tool to check off each transaction against your bank statement.</li>
                                            <li>Ensure the final balance in Bookkeeper Pro matches your bank statement's ending balance.</li>
                                            <li>Investigate any discrepancies immediately.</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- Accordion Item 2 -->
                                <div class="border rounded-lg">
                                    <button class="accordion-header w-full text-left p-4 bg-gray-100 hover:bg-gray-200 focus:outline-none flex justify-between items-center">
                                        <span class="font-medium">2. Job Costing & Profitability</span>
                                        <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content p-4 border-t">
                                        <p class="mb-2"><strong>What it is:</strong> Tracking all income and expenses associated with a specific job or customer to determine its profitability.</p>
                                        <p><strong>How to do it:</strong></p>
                                        <ol class="list-decimal list-inside ml-4 space-y-1">
                                            <li>In the "Transactions" view, click 'Edit' on each transaction.</li>
                                            <li>Assign a unique "Job/Customer Name" to all related income (customer payments) and expenses (parts, materials, labor).</li>
                                            <li>Switch to the "Job Profitability" tab to see a real-time summary of profit for each job.</li>
                                            <li>Use this insight to adjust your pricing and identify your most profitable types of work.</li>
                                        </ol>
                                    </div>
                                </div>
                                 <!-- Accordion Item 3 -->
                                <div class="border rounded-lg">
                                    <button class="accordion-header w-full text-left p-4 bg-gray-100 hover:bg-gray-200 focus:outline-none flex justify-between items-center">
                                        <span class="font-medium">3. Accounts Payable (Bills) & Receivable (Invoices)</span>
                                        <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content p-4 border-t">
                                        <p class="mb-2"><strong>Accounts Payable (A/P):</strong> Money you owe to suppliers. Track bills from parts distributors, for van maintenance, etc. Pay them on time to maintain good relationships and credit.</p>
                                        <p class="mb-2"><strong>Accounts Receivable (A/R):</strong> Money customers owe you. Send invoices promptly after a job is complete and follow up on unpaid invoices to ensure healthy cash flow.</p>
                                        <p><strong>How this tool helps:</strong> When you pay a bill or receive a payment, it will appear in your imported bank transactions. Categorize it appropriately (e.g., "Parts & Materials" for a supplier bill, "Income" for a customer payment) and assign it to the correct job.</p>
                                    </div>
                                </div>
                                <!-- Accordion Item 4 -->
                                <div class="border rounded-lg">
                                    <button class="accordion-header w-full text-left p-4 bg-gray-100 hover:bg-gray-200 focus:outline-none flex justify-between items-center">
                                        <span class="font-medium">4. Inventory Management</span>
                                        <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="accordion-content p-4 border-t">
                                        <p class="mb-2"><strong>What it is:</strong> Tracking the parts and equipment you have in stock, both in your shop and in your service vans.</p>
                                        <p><strong>How to do it:</strong></p>
                                         <ol class="list-decimal list-inside ml-4 space-y-1">
                                            <li>Keep a simple spreadsheet or use dedicated software to list all inventory items.</li>
                                            <li>When you purchase new parts, categorize the transaction as "Inventory Purchase" or similar.</li>
                                            <li>When you use a part on a job, note it in your job costs. This moves the cost from an asset (inventory) to an expense (Cost of Goods Sold).</li>
                                            <li>Periodically count your physical inventory to ensure it matches your records.</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95">
            <div class="p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-2">Edit Transaction</h3>
                <p id="modal-description" class="text-sm text-gray-600 mb-4"></p>
                
                <form id="edit-form">
                    <input type="hidden" id="modal-transaction-id">
                    <div>
                        <label for="modal-category" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="modal-category" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <!-- Options will be inserted here -->
                        </select>
                    </div>
                    <div class="mt-4">
                        <label for="modal-job" class="block text-sm font-medium text-gray-700">Job/Customer Name</label>
                        <input type="text" id="modal-job" list="job-list" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-gray-300 rounded-md" placeholder="e.g., Smith Residence Install">
                        <datalist id="job-list"></datalist>
                    </div>
                    <div class="mt-4">
                        <label for="modal-notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="modal-notes" rows="3" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-gray-300 rounded-md"></textarea>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="save-button" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">Save</button>
                <button id="cancel-button" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Manage Categories Modal -->
    <div id="category-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg m-4 transform scale-95">
             <div class="p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Manage Categories</h3>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="new-category-name" placeholder="New category name" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <button id="add-new-category-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Add</button>
                </div>
                <div id="category-list" class="max-h-60 overflow-y-auto pr-2">
                    <!-- Category list will be populated here -->
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="close-category-modal" type="button" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm">Done</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95">
            <div class="p-6">
                <div class="flex items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="confirm-modal-title">Clear Session Data</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500" id="confirm-modal-body">Are you sure you want to clear all saved transaction data? This action cannot be undone.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="confirm-delete-button" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">Delete</button>
                <button id="cancel-delete-button" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md transition-transform duration-300">
        Session Saved!
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let transactions = [];
            let categories = [
                'Uncategorized', 'Income', 'Office Supplies', 'Rent', 
                'Utilities', 'Travel', 'Meals', 'Software', 'Marketing'
            ];

            // --- DOM ELEMENTS ---
            const csvFileInput = document.getElementById('csv-file');
            const fileInfo = document.getElementById('file-info');
            const uploadSection = document.getElementById('upload-section');
            const dataSection = document.getElementById('data-section');
            const transactionTableBody = document.getElementById('transaction-table');
            const totalIncomeEl = document.getElementById('total-income');
            const totalExpenseEl = document.getElementById('total-expense');
            const netTotalEl = document.getElementById('net-total');
            const exportButton = document.getElementById('export-button');
            const saveSessionButton = document.getElementById('save-session-button');
            const clearSessionButton = document.getElementById('clear-session-button');


            // Tab elements
            const tabTransactions = document.getElementById('tab-transactions');
            const tabJobs = document.getElementById('tab-jobs');
            const tabGuide = document.getElementById('tab-guide');
            const viewTransactions = document.getElementById('view-transactions');
            const viewJobs = document.getElementById('view-jobs');
            const viewGuide = document.getElementById('view-guide');
            const jobTableBody = document.getElementById('job-table');
            const quickbooksInputs = document.getElementById('quickbooks-inputs');

            // Modal elements
            const editModal = document.getElementById('edit-modal');
            const modalDescription = document.getElementById('modal-description');
            const modalTransactionId = document.getElementById('modal-transaction-id');
            const modalCategory = document.getElementById('modal-category');
            const modalJob = document.getElementById('modal-job');
            const modalNotes = document.getElementById('modal-notes');
            const saveButton = document.getElementById('save-button');
            const cancelButton = document.getElementById('cancel-button');

            // Category Modal elements
            const categoryModal = document.getElementById('category-modal');
            const addCategoryButton = document.getElementById('add-category-button');
            const closeCategoryModalButton = document.getElementById('close-category-modal');
            const addNewCategoryBtn = document.getElementById('add-new-category-btn');
            const newCategoryNameInput = document.getElementById('new-category-name');
            const categoryListContainer = document.getElementById('category-list');
            
            const bankAccountInput = document.getElementById('bank-account');
            const defaultExpenseAccountInput = document.getElementById('default-expense-account');
            const monthFilter = document.getElementById('month-filter');
            const monthFilterContainer = document.getElementById('month-filter-container');

            // Confirmation Modal elements
            const confirmModal = document.getElementById('confirm-modal');
            const confirmDeleteButton = document.getElementById('confirm-delete-button');
            const cancelDeleteButton = document.getElementById('cancel-delete-button');


            // --- FUNCTIONS ---
             const showToast = (message, isError = false) => {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.toggle('bg-red-500', isError);
                toast.classList.toggle('bg-green-500', !isError);
                toast.style.transform = 'translateX(0)';
                setTimeout(() => {
                    toast.style.transform = 'translateX(150%)';
                }, 3000);
            };

            const saveSession = () => {
                if (transactions.length > 0) {
                    localStorage.setItem('bookkeeperTransactions', JSON.stringify(transactions));
                    showToast('Session saved successfully!');
                } else {
                    showToast('No transactions to save.', true);
                }
            };

            const openConfirmModal = () => {
                confirmModal.classList.remove('hidden');
                setTimeout(() => confirmModal.querySelector('.modal-content').classList.replace('scale-95', 'scale-100'), 10);
            };

            const closeConfirmModal = () => {
                confirmModal.querySelector('.modal-content').classList.replace('scale-100', 'scale-95');
                setTimeout(() => confirmModal.classList.add('hidden'), 300);
            }

            const clearSession = () => {
                localStorage.removeItem('bookkeeperTransactions');
                transactions = [];
                dataSection.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                monthFilterContainer.classList.add('hidden');
                fileInfo.textContent = '';
                closeConfirmModal();
                 showToast('Session data cleared.');
            };
            
            const loadSession = () => {
                const savedTransactions = localStorage.getItem('bookkeeperTransactions');
                if (savedTransactions) {
                    transactions = JSON.parse(savedTransactions);
                    if (transactions.length > 0) {
                        populateMonthFilter();
                        renderAllData();
                        uploadSection.classList.add('hidden');
                        dataSection.classList.remove('hidden');
                        monthFilterContainer.classList.remove('hidden');
                    }
                }
            };


            const formatCurrency = (amount) => {
                const value = parseFloat(amount);
                return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            };
            
            const loadCategories = () => {
                const savedCategories = localStorage.getItem('bookkeeperCategories');
                if(savedCategories){
                    categories = JSON.parse(savedCategories);
                }
                populateCategoryDropdowns();
                populateCategoryManagementList();
            };

            const saveCategories = () => {
                localStorage.setItem('bookkeeperCategories', JSON.stringify(categories));
            };

            const renderAllData = () => {
                const selectedMonth = monthFilter.value;
                let filteredTransactions;

                if (selectedMonth === 'all') {
                    filteredTransactions = [...transactions];
                } else {
                    filteredTransactions = transactions.filter(tx => {
                        const date = new Date(tx.date);
                        const year = date.getFullYear();
                        const month = date.getMonth() + 1;
                        const monthStr = `${year}-${String(month).padStart(2, '0')}`;
                        return monthStr === selectedMonth;
                    });
                }

                renderTransactions(filteredTransactions);
                updateDashboard(filteredTransactions);
                renderJobProfitability(filteredTransactions);
            };

            const renderTransactions = (data) => {
                transactionTableBody.innerHTML = '';
                if (data.length === 0) {
                     transactionTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">No transactions for the selected period.</td></tr>`;
                     return;
                }
                
                data.forEach(tx => {
                    const row = document.createElement('tr');
                    const amountClass = tx.amount >= 0 ? 'text-green-600' : 'text-red-600';
                    const categoryClass = tx.category === 'Uncategorized' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 max-w-xs truncate" title="${tx.description}">${tx.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${amountClass}">${formatCurrency(tx.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${categoryClass}">${tx.category}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.job || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${tx.id}" class="edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                        </td>
                    `;
                    transactionTableBody.appendChild(row);
                });
            };

            const updateDashboard = (data) => {
                const income = data.filter(tx => tx.amount >= 0).reduce((sum, tx) => sum + tx.amount, 0);
                const expense = data.filter(tx => tx.amount < 0).reduce((sum, tx) => sum + tx.amount, 0);
                const net = income + expense;

                totalIncomeEl.textContent = formatCurrency(income);
                totalExpenseEl.textContent = formatCurrency(Math.abs(expense));
                netTotalEl.textContent = formatCurrency(net);
                netTotalEl.parentElement.classList.toggle('bg-red-50', net < 0);
                netTotalEl.parentElement.classList.toggle('border-red-500', net < 0);
                netTotalEl.parentElement.classList.toggle('text-red-800', net < 0);
                netTotalEl.parentElement.classList.toggle('bg-green-50', net >= 0);
                netTotalEl.parentElement.classList.toggle('border-green-500', net >= 0);
                netTotalEl.parentElement.classList.toggle('text-green-800', net >= 0);

            };

            const handleFileSelect = (file) => {
                if (!file) return;
                
                fileInfo.textContent = `File: ${file.name}`;
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        let newCategoriesFound = false;
                        transactions = results.data.map((row, index) => {
                            // More flexible key finding
                            let dateKey = Object.keys(row).find(k => k.toLowerCase().includes('date'));
                            let descriptionKey = Object.keys(row).find(k => k.toLowerCase().includes('description') || k.toLowerCase().includes('memo'));
                            let classificationKey = Object.keys(row).find(k => k.toLowerCase() === 'classification');
                            
                            // Handle separate Debit/Credit columns OR a single Amount column
                            let debitKey = Object.keys(row).find(k => k.toLowerCase() === 'debit');
                            let creditKey = Object.keys(row).find(k => k.toLowerCase() === 'credit');
                            let amountKey = Object.keys(row).find(k => k.toLowerCase().includes('amount'));

                            // Check for required columns
                            if (!dateKey || !descriptionKey) {
                                console.error('CSV must have columns for Date and Description.', row);
                                return null;
                            }
                            
                            let amount = 0;
                            // Prioritize Debit/Credit columns if they exist
                            if (debitKey || creditKey) {
                                const debitValue = row[debitKey] || "0";
                                const creditValue = row[creditKey] || "0";
                                const debit = parseFloat(debitValue.replace(/[^0-9.-]+/g, ""));
                                const credit = parseFloat(creditValue.replace(/[^0-9.-]+/g, ""));
                                
                                if (!isNaN(debit) && debit !== 0) {
                                    amount = -debit; // Debits are expenses
                                } else if (!isNaN(credit) && credit !== 0) {
                                    amount = credit; // Credits are income
                                }
                            } else if (amountKey) { // Fallback to a single Amount column
                                const rawAmount = row[amountKey] || "0";
                                amount = parseFloat(rawAmount.replace(/[^0-9.-]+/g, ""));
                            } else {
                                console.error('CSV must have an "Amount" column or "Debit"/"Credit" columns.', row);
                                return null; // No amount information found
                            }
                            
                            const initialCategory = (classificationKey && row[classificationKey] && row[classificationKey].trim()) || 'Uncategorized';

                            if (initialCategory !== 'Uncategorized' && !categories.includes(initialCategory)) {
                                categories.push(initialCategory);
                                newCategoriesFound = true;
                            }

                            return {
                                id: index,
                                date: new Date(row[dateKey]).toLocaleDateString(),
                                description: row[descriptionKey] || 'No Description',
                                amount: isNaN(amount) ? 0 : amount,
                                category: initialCategory,
                                notes: '',
                                job: ''
                            };
                        }).filter(Boolean); // Filter out nulls from failed parsing

                        if (newCategoriesFound) {
                            categories.sort();
                            saveCategories();
                            populateCategoryDropdowns();
                            populateCategoryManagementList();
                        }

                        populateMonthFilter();
                        renderAllData();
                        
                        uploadSection.classList.add('hidden');
                        dataSection.classList.remove('hidden');
                        monthFilterContainer.classList.remove('hidden');
                    },
                    error: (error) => {
                        console.error('CSV Parsing Error:', error);
                        fileInfo.textContent = 'Error parsing CSV file. Check console for details.';
                    }
                });
            };
            
            const openEditModal = (transactionId) => {
                const tx = transactions.find(t => t.id === transactionId);
                if (!tx) return;
                
                modalTransactionId.value = tx.id;
                modalDescription.textContent = tx.description;
                modalJob.value = tx.job;
                modalNotes.value = tx.notes;
                
                populateCategoryDropdowns();
                updateJobDatalist();
                modalCategory.value = tx.category;
                
                editModal.classList.remove('hidden');
                setTimeout(() => editModal.querySelector('.modal-content').classList.replace('scale-95', 'scale-100'), 10);
            };
            
            const closeEditModal = () => {
                editModal.querySelector('.modal-content').classList.replace('scale-100', 'scale-95');
                setTimeout(() => editModal.classList.add('hidden'), 300);
            };

            const saveTransaction = () => {
                const transactionId = parseInt(modalTransactionId.value);
                const tx = transactions.find(t => t.id === transactionId);
                if (tx) {
                    tx.category = modalCategory.value;
                    tx.job = modalJob.value.trim();
                    tx.notes = modalNotes.value;
                }
                renderAllData();
                closeEditModal();
            };

            const populateCategoryDropdowns = () => {
                modalCategory.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            };

            const populateCategoryManagementList = () => {
                 categoryListContainer.innerHTML = '';
                 categories.forEach(cat => {
                     const isProtected = ['Uncategorized'].includes(cat);
                     const item = document.createElement('div');
                     item.className = 'flex justify-between items-center p-2 rounded-md hover:bg-gray-100';
                     item.innerHTML = `
                        <span>${cat}</span>
                        ${isProtected ? '' : `<button data-category="${cat}" class="delete-category-btn text-red-500 hover:text-red-700 text-sm font-semibold">Remove</button>`}
                     `;
                     categoryListContainer.appendChild(item);
                 });
            };

            const addCategory = (name) => {
                const newCat = name.trim();
                if(newCat && !categories.includes(newCat)){
                    categories.push(newCat);
                    categories.sort();
                    saveCategories();
                    populateCategoryManagementList();
                    populateCategoryDropdowns();
                }
                newCategoryNameInput.value = '';
            };

            const removeCategory = (name) => {
                if(name === 'Uncategorized') return;
                
                categories = categories.filter(c => c !== name);
                transactions.forEach(tx => {
                    if(tx.category === name) {
                        tx.category = 'Uncategorized';
                    }
                });
                
                saveCategories();
                populateCategoryManagementList();
                populateCategoryDropdowns();
                renderAllData();
            };

            const exportToIIF = () => {
                const bankAccount = bankAccountInput.value.trim();
                const defaultExpenseAccount = defaultExpenseAccountInput.value.trim();

                if (!bankAccount || !defaultExpenseAccount) {
                    alert('Please enter both the QuickBooks Bank Account and Default Expense Account names before exporting.');
                    return;
                }

                let iifContent = `!TRNS\tTRNSID\tTRNSTYPE\tDATE\tACCNT\tNAME\tAMOUNT\tDOCNUM\tMEMO\n`;
                iifContent += `!SPL\tSPLID\tTRNSTYPE\tDATE\tACCNT\tNAME\tAMOUNT\tDOCNUM\tMEMO\n`;
                iifContent += `!ENDTRNS\n`;

                transactions.forEach((tx, index) => {
                    const date = new Date(tx.date).toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
                    const name = tx.job || tx.description.substring(0, 30).replace(/\s+/g, ' '); // Use job name if available
                    const memo = `${tx.description} ${tx.notes || ''}`.trim().substring(0, 100);
                    const amount = tx.amount.toFixed(2);
                    const isExpense = tx.amount < 0;
                    
                    const transactionType = isExpense ? 'EXPENSE' : 'DEPOSIT';
                    const categoryAccount = tx.category === 'Uncategorized' ? defaultExpenseAccount : tx.category;

                    iifContent += `TRNS\t\t${transactionType}\t${date}\t${bankAccount}\t${name}\t${amount}\t\t${memo}\n`;
                    iifContent += `SPL\t\t${transactionType}\t${date}\t${categoryAccount}\t${name}\t${-amount}\t\t${memo}\n`;
                    iifContent += `ENDTRNS\n`;
                });

                const blob = new Blob([iifContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'quickbooks_import.iif';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const updateJobDatalist = () => {
                const jobList = document.getElementById('job-list');
                const existingJobs = [...new Set(transactions.map(tx => tx.job).filter(j => j))];
                jobList.innerHTML = existingJobs.map(j => `<option value="${j}"></option>`).join('');
            };

            const renderJobProfitability = (data) => {
                const jobs = {};
                data.forEach(tx => {
                    if(tx.job) {
                        if (!jobs[tx.job]) {
                            jobs[tx.job] = { income: 0, expenses: 0 };
                        }
                        if (tx.amount >= 0) {
                            jobs[tx.job].income += tx.amount;
                        } else {
                            jobs[tx.job].expenses += tx.amount;
                        }
                    }
                });

                jobTableBody.innerHTML = '';
                if (Object.keys(jobs).length === 0) {
                    jobTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">No jobs with assigned transactions in this period.</td></tr>`;
                    return;
                }

                Object.keys(jobs).sort().forEach(jobName => {
                    const job = jobs[jobName];
                    const net = job.income + job.expenses;
                    const netClass = net >= 0 ? 'text-green-600' : 'text-red-600';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${jobName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">${formatCurrency(job.income)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">${formatCurrency(Math.abs(job.expenses))}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${netClass}">${formatCurrency(net)}</td>
                    `;
                    jobTableBody.appendChild(row);
                });
            };
            
            const populateMonthFilter = () => {
                const months = new Set();
                transactions.forEach(tx => {
                    const date = new Date(tx.date);
                    if (isNaN(date.getTime())) return;
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    months.add(`${year}-${String(month).padStart(2, '0')}`);
                });

                const sortedMonths = Array.from(months).sort().reverse();
                monthFilter.innerHTML = '<option value="all">All Time</option>';
                sortedMonths.forEach(monthStr => {
                    const [year, month] = monthStr.split('-');
                    const date = new Date(year, month - 1);
                    const monthName = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                    monthFilter.innerHTML += `<option value="${monthStr}">${monthName}</option>`;
                });
            };


            // --- EVENT LISTENERS ---
            csvFileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
            
            // Drag and drop
            const dropzone = csvFileInput.parentElement;
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('bg-gray-200');
            });
            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('bg-gray-200');
            });
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('bg-gray-200');
                const file = e.dataTransfer.files[0];
                if (file && file.type === "text/csv") {
                    handleFileSelect(file);
                }
            });


            transactionTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-btn')) {
                    const transactionId = parseInt(e.target.dataset.id);
                    openEditModal(transactionId);
                }
            });

            saveButton.addEventListener('click', saveTransaction);
            cancelButton.addEventListener('click', closeEditModal);
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !editModal.classList.contains('hidden')) {
                    closeEditModal();
                }
                if (e.key === 'Escape' && !categoryModal.classList.contains('hidden')) {
                    categoryModal.classList.add('hidden');
                }
            });
            
            exportButton.addEventListener('click', exportToIIF);
            monthFilter.addEventListener('change', renderAllData);
            
            // Tab switching
            tabTransactions.addEventListener('click', () => {
                viewTransactions.classList.remove('hidden');
                viewJobs.classList.add('hidden');
                viewGuide.classList.add('hidden');
                quickbooksInputs.style.display = 'grid';

                tabTransactions.classList.add('border-indigo-500', 'text-indigo-600');
                tabTransactions.classList.remove('border-transparent', 'text-gray-500');
                
                tabJobs.classList.remove('border-indigo-500', 'text-indigo-600');
                tabJobs.classList.add('border-transparent', 'text-gray-500');

                tabGuide.classList.remove('border-indigo-500', 'text-indigo-600');
                tabGuide.classList.add('border-transparent', 'text-gray-500');

            });
            tabJobs.addEventListener('click', () => {
                viewTransactions.classList.add('hidden');
                viewJobs.classList.remove('hidden');
                viewGuide.classList.add('hidden');
                quickbooksInputs.style.display = 'grid';
                
                tabJobs.classList.add('border-indigo-500', 'text-indigo-600');
                tabJobs.classList.remove('border-transparent', 'text-gray-500');

                tabTransactions.classList.remove('border-indigo-500', 'text-indigo-600');
                tabTransactions.classList.add('border-transparent', 'text-gray-500');

                tabGuide.classList.remove('border-indigo-500', 'text-indigo-600');
                tabGuide.classList.add('border-transparent', 'text-gray-500');
            });
            tabGuide.addEventListener('click', () => {
                viewTransactions.classList.add('hidden');
                viewJobs.classList.add('hidden');
                viewGuide.classList.remove('hidden');
                quickbooksInputs.style.display = 'none';

                tabGuide.classList.add('border-indigo-500', 'text-indigo-600');
                tabGuide.classList.remove('border-transparent', 'text-gray-500');

                tabTransactions.classList.remove('border-indigo-500', 'text-indigo-600');
                tabTransactions.classList.add('border-transparent', 'text-gray-500');

                tabJobs.classList.remove('border-indigo-500', 'text-indigo-600');
                tabJobs.classList.add('border-transparent', 'text-gray-500');
            });


            addCategoryButton.addEventListener('click', () => {
                categoryModal.classList.remove('hidden');
                setTimeout(() => categoryModal.querySelector('.modal-content').classList.replace('scale-95', 'scale-100'), 10);
            });

            closeCategoryModalButton.addEventListener('click', () => {
                categoryModal.querySelector('.modal-content').classList.replace('scale-100', 'scale-95');
                setTimeout(() => categoryModal.classList.add('hidden'), 300);
            });

            addNewCategoryBtn.addEventListener('click', () => addCategory(newCategoryNameInput.value));
            newCategoryNameInput.addEventListener('keypress', (e) => {
                if(e.key === 'Enter') addCategory(newCategoryNameInput.value);
            });

            categoryListContainer.addEventListener('click', (e) => {
                if(e.target.classList.contains('delete-category-btn')){
                    removeCategory(e.target.dataset.category);
                }
            });

            document.getElementById('accordion-container').addEventListener('click', e => {
                const header = e.target.closest('.accordion-header');
                if (!header) return;

                const content = header.nextElementSibling;
                const icon = header.querySelector('svg');

                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    document.querySelectorAll('.accordion-content').forEach(el => {
                        el.style.maxHeight = null;
                        el.previousElementSibling.querySelector('svg').style.transform = 'rotate(0deg)';
                    });
                    content.style.maxHeight = content.scrollHeight + "px";
                    icon.style.transform = 'rotate(180deg)';
                }
            });
            
            // --- INITIALIZATION ---
            loadCategories();
            loadSession();
        });
    </script>
</body>
</html>


